<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chipatala Connect ‚Äì Doctor Portal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  :root {
    --navy: #1F4E79; --blue: #2E75B6; --sky: #BDD7EE; --lightblue: #D5E8F0;
    --green: #107C10; --green-light: #DFF0D8; --red: #C00000; --red-light: #FDECEA;
    --amber: #C7760A; --amber-light: #FFF3CD;
    --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0;
    --gray-400: #94A3B8; --gray-600: #475569; --gray-800: #1E293B;
    --white: #FFFFFF;
    --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --radius: 8px; --shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--gray-50); color: var(--gray-800); min-height: 100vh; }
  .hidden { display: none !important; }

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #screen-login {
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%);
  }
  .login-card {
    background: white; border-radius: 16px; padding: 48px 40px; width: 420px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .login-logo { text-align: center; margin-bottom: 32px; }
  .login-logo .logo-icon {
    width: 64px; height: 64px; background: var(--blue); border-radius: 16px;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 28px; margin-bottom: 12px;
  }
  .login-logo h1 { font-size: 24px; font-weight: 700; color: var(--navy); }
  .login-logo p { font-size: 13px; color: var(--gray-600); margin-top: 4px; }
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 11px 14px; border: 1.5px solid var(--gray-200); border-radius: var(--radius);
    font-size: 14px; font-family: var(--font); transition: border-color .2s;
    background: white; color: var(--gray-800);
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(46,117,182,.15);
  }
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 11px 20px; border-radius: var(--radius); font-size: 14px; font-weight: 600;
    cursor: pointer; border: none; transition: all .2s; font-family: var(--font);
  }
  .btn-primary { background: var(--blue); color: white; }
  .btn-primary:hover { background: var(--navy); }
  .btn-success { background: var(--green); color: white; }
  .btn-success:hover { background: #0a5a0a; }
  .btn-danger { background: var(--red); color: white; }
  .btn-danger:hover { background: #900000; }
  .btn-ghost { background: transparent; color: var(--blue); border: 1.5px solid var(--blue); }
  .btn-ghost:hover { background: var(--lightblue); }
  .btn-amber { background: var(--amber); color: white; }
  .btn-full { width: 100%; justify-content: center; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  #screen-main { display: flex; min-height: 100vh; }
  .sidebar {
    width: 240px; background: var(--navy); color: white; flex-shrink: 0;
    display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100;
  }
  .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,.1); }
  .sidebar-header .brand { font-size: 15px; font-weight: 700; }
  .sidebar-header .brand span { color: var(--sky); }
  .sidebar-header .user-badge {
    margin-top: 12px; background: rgba(255,255,255,.08); border-radius: 8px;
    padding: 10px; display: flex; align-items: center; gap: 10px;
  }
  .sidebar-header .user-badge .avatar {
    width: 36px; height: 36px; background: var(--blue); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700;
  }
  .sidebar-header .user-badge .user-info { flex: 1; min-width: 0; }
  .sidebar-header .user-badge .user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sidebar-header .user-badge .user-role { font-size: 11px; color: var(--sky); opacity: .8; }
  .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
  .nav-section-label { font-size: 10px; font-weight: 700; color: rgba(255,255,255,.4); letter-spacing: .08em; text-transform: uppercase; padding: 12px 20px 4px; }
  .nav-item {
    display: flex; align-items: center; gap: 12px;
    padding: 11px 20px; font-size: 13px; cursor: pointer;
    transition: background .15s; position: relative;
  }
  .nav-item:hover { background: rgba(255,255,255,.06); }
  .nav-item.active { background: rgba(255,255,255,.12); }
  .nav-item .nav-icon { width: 20px; text-align: center; opacity: .8; font-size: 15px; }
  .nav-item .nav-badge {
    margin-left: auto; background: var(--red); color: white;
    border-radius: 10px; font-size: 10px; font-weight: 700; padding: 2px 6px; min-width: 18px; text-align: center;
  }
  .sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,.1); }
  .sidebar-footer .facility-badge {
    font-size: 11px; color: var(--sky); opacity: .7;
  }

  .main-content { margin-left: 240px; flex: 1; padding: 0; }
  .page-header {
    background: white; border-bottom: 1px solid var(--gray-200);
    padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 50;
  }
  .page-header h2 { font-size: 20px; font-weight: 700; color: var(--navy); }
  .page-header p { font-size: 13px; color: var(--gray-600); margin-top: 2px; }
  .page-body { padding: 28px 32px; }

  /* ‚îÄ‚îÄ CARDS & PANELS ‚îÄ‚îÄ */
  .card {
    background: white; border-radius: var(--radius); box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
  }
  .card-header { padding: 18px 24px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
  .card-header h3 { font-size: 15px; font-weight: 700; color: var(--navy); }
  .card-body { padding: 24px; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 28px; }
  .stat-card { background: white; border-radius: var(--radius); padding: 20px; border: 1px solid var(--gray-200); box-shadow: var(--shadow); }
  .stat-card .stat-label { font-size: 12px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: .05em; }
  .stat-card .stat-value { font-size: 32px; font-weight: 700; color: var(--navy); margin: 6px 0 2px; }
  .stat-card .stat-sub { font-size: 12px; color: var(--gray-400); }
  .stat-card .stat-icon { float: right; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }

  /* ‚îÄ‚îÄ BADGE / STATUS ‚îÄ‚îÄ */
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: .03em; }
  .badge-pending { background: var(--amber-light); color: var(--amber); }
  .badge-active { background: var(--green-light); color: var(--green); }
  .badge-expired { background: var(--gray-100); color: var(--gray-600); }
  .badge-revoked { background: var(--red-light); color: var(--red); }
  .badge-denied { background: var(--red-light); color: var(--red); }
  .badge-success { background: var(--green-light); color: var(--green); }
  .badge-info { background: var(--lightblue); color: var(--navy); }

  /* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { background: var(--gray-50); padding: 10px 14px; font-size: 11px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: .05em; text-align: left; border-bottom: 1px solid var(--gray-200); }
  .data-table td { padding: 12px 14px; font-size: 13px; border-bottom: 1px solid var(--gray-100); }
  .data-table tr:hover td { background: var(--gray-50); }
  .data-table tr:last-child td { border-bottom: none; }

  /* ‚îÄ‚îÄ SESSION TIMER ‚îÄ‚îÄ */
  .session-bar {
    background: linear-gradient(90deg, var(--green) 0%, #1a9e1a 100%);
    color: white; padding: 12px 32px; display: flex; align-items: center; gap: 16px;
    font-size: 13px; font-weight: 600; position: sticky; top: 65px; z-index: 40;
  }
  .session-bar .timer { font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; background: rgba(0,0,0,.2); padding: 4px 12px; border-radius: 6px; }
  .session-bar.expiring { background: linear-gradient(90deg, var(--amber) 0%, #d4870e 100%); }
  .session-bar.critical { background: linear-gradient(90deg, var(--red) 0%, #a00000 100%); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .8; } }

  /* ‚îÄ‚îÄ QR CODE ‚îÄ‚îÄ */
  .qr-modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 200;
    display: flex; align-items: center; justify-content: center;
  }
  .qr-modal {
    background: white; border-radius: 16px; padding: 36px; width: 440px; text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
  }
  .qr-modal h3 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 6px; }
  .qr-modal p { font-size: 13px; color: var(--gray-600); margin-bottom: 24px; }
  #qr-canvas-container { display: flex; justify-content: center; margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px; }
  .qr-payload-preview { font-size: 10px; color: var(--gray-400); font-family: monospace; background: var(--gray-50); border-radius: 6px; padding: 10px; text-align: left; margin-bottom: 20px; max-height: 100px; overflow-y: auto; word-break: break-all; }

  /* ‚îÄ‚îÄ CONSENT PENDING ‚îÄ‚îÄ */
  .consent-wait {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 48px; text-align: center;
  }
  .consent-wait .spinner {
    width: 56px; height: 56px; border: 4px solid var(--sky); border-top-color: var(--blue);
    border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 24px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ RECORD FHIR CARD ‚îÄ‚îÄ */
  .record-card {
    border: 1.5px solid var(--gray-200); border-radius: var(--radius);
    margin-bottom: 16px; overflow: hidden;
  }
  .record-card-header {
    padding: 14px 18px; background: var(--gray-50); display: flex; align-items: center;
    gap: 12px; cursor: pointer; user-select: none;
  }
  .record-card-header:hover { background: var(--lightblue); }
  .record-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
  .record-icon.encounter { background: var(--lightblue); }
  .record-icon.lab { background: #FFF3CD; }
  .record-icon.prescription { background: var(--green-light); }
  .record-icon.vaccination { background: #EDE9FE; }
  .record-card-body { padding: 18px; display: none; }
  .record-card.expanded .record-card-body { display: block; }
  .fhir-tag { display: inline-block; background: var(--lightblue); color: var(--navy); font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 4px; margin-right: 4px; margin-bottom: 4px; font-family: monospace; }

  /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
  .alert { padding: 14px 18px; border-radius: var(--radius); margin-bottom: 16px; font-size: 13px; display: flex; align-items: flex-start; gap: 10px; }
  .alert-success { background: var(--green-light); color: var(--green); border: 1px solid #c3e6cb; }
  .alert-danger { background: var(--red-light); color: var(--red); border: 1px solid #f5c6cb; }
  .alert-warning { background: var(--amber-light); color: var(--amber); border: 1px solid #ffc107; }
  .alert-info { background: var(--lightblue); color: var(--navy); border: 1px solid var(--sky); }

  /* ‚îÄ‚îÄ FORM GRID ‚îÄ‚îÄ */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .col-span-2 { grid-column: span 2; }

  /* ‚îÄ‚îÄ PATIENT PROFILE HEADER ‚îÄ‚îÄ */
  .patient-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%);
    color: white; padding: 28px 32px; border-radius: var(--radius) var(--radius) 0 0;
    display: flex; align-items: center; gap: 20px;
  }
  .patient-avatar {
    width: 64px; height: 64px; background: rgba(255,255,255,.15); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700;
  }
  .patient-info .name { font-size: 22px; font-weight: 700; }
  .patient-info .mnid { font-size: 13px; color: var(--sky); font-family: monospace; margin-top: 3px; }
  .patient-info .meta { font-size: 12px; color: rgba(255,255,255,.7); margin-top: 6px; }

  /* ‚îÄ‚îÄ SCOPE CHECKBOXES ‚îÄ‚îÄ */
  .scope-options { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
  .scope-chip { display: flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 20px; border: 1.5px solid var(--gray-200); cursor: pointer; font-size: 12px; font-weight: 600; user-select: none; transition: all .15s; }
  .scope-chip:hover { border-color: var(--blue); background: var(--lightblue); }
  .scope-chip input { display: none; }
  .scope-chip.checked { background: var(--blue); color: white; border-color: var(--blue); }

  /* ‚îÄ‚îÄ APPOINTMENTS ‚îÄ‚îÄ */
  .appt-slot { padding: 12px 16px; border: 1.5px solid var(--gray-200); border-radius: var(--radius); margin-bottom: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all .15s; }
  .appt-slot:hover { border-color: var(--blue); background: var(--lightblue); }
  .appt-slot.booked { border-color: var(--green); background: var(--green-light); cursor: default; }

  /* ‚îÄ‚îÄ AUDIT ‚îÄ‚îÄ */
  .audit-row { padding: 10px 0; border-bottom: 1px solid var(--gray-100); display: flex; align-items: flex-start; gap: 12px; font-size: 12px; }
  .audit-event-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--gray-200); border-radius: 3px; }

  /* ‚îÄ‚îÄ SEARCH BOX ‚îÄ‚îÄ */
  .search-box { position: relative; }
  .search-box input { padding-left: 40px; }
  .search-box .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-400); font-size: 16px; }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state { text-align: center; padding: 48px 24px; color: var(--gray-400); }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state p { font-size: 14px; }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast { background: var(--gray-800); color: white; padding: 12px 18px; border-radius: var(--radius); font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,.3); display: flex; align-items: center; gap: 10px; animation: slideIn .3s ease; max-width: 320px; }
  .toast.success { background: var(--green); }
  .toast.error { background: var(--red); }
  .toast.warning { background: var(--amber); }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Divider */
  hr { border: none; border-top: 1px solid var(--gray-200); margin: 20px 0; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-login">
  <div class="login-card">
    <div class="login-logo">
      <div class="logo-icon">üè•</div>
      <h1>Chipatala Connect</h1>
      <p>Clinician Portal &nbsp;¬∑&nbsp; v1.0</p>
    </div>
    <div id="login-error" class="alert alert-danger hidden"></div>
    <div class="form-group">
      <label>Doctor ID or Email</label>
      <input type="text" id="login-username" placeholder="e.g. DR-001 or amara.banda@kch.mw" autocomplete="username">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="Enter your password" autocomplete="current-password">
    </div>
    <div class="form-group">
      <label>Facility</label>
      <select id="login-facility">
        <option value="KCH-001">Kamuzu Central Hospital (KCH)</option>
        <option value="QECH-002">Queen Elizabeth Central Hospital (QECH)</option>
        <option value="DHO-MLJ-003">Mchinji District Hospital</option>
        <option value="BAOBAB-004">Baobab Health Clinic ‚Äì Lilongwe</option>
      </select>
    </div>
    <button class="btn btn-primary btn-full" onclick="doLogin()">üîê &nbsp;Sign In Securely</button>
    <p style="font-size:11px;color:var(--gray-400);text-align:center;margin-top:16px;">
      Demo accounts: DR-001 / password123 &nbsp;|&nbsp; DR-002 / password123
    </p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-main" class="hidden">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="brand">‚öïÔ∏è <span>Chipatala</span> Connect</div>
      <div class="user-badge">
        <div class="avatar" id="sb-avatar">AB</div>
        <div class="user-info">
          <div class="user-name" id="sb-name">Dr. Amara Banda</div>
          <div class="user-role" id="sb-role">Internal Medicine</div>
        </div>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Clinical</div>
      <div class="nav-item active" data-view="dashboard" onclick="navigate('dashboard')">
        <span class="nav-icon">üìä</span> Dashboard
      </div>
      <div class="nav-item" data-view="patient-search" onclick="navigate('patient-search')">
        <span class="nav-icon">üîç</span> Patient Lookup
      </div>
      <div class="nav-item" data-view="active-session" onclick="navigate('active-session')">
        <span class="nav-icon">üîì</span> Active Session
        <span class="nav-badge hidden" id="session-badge">1</span>
      </div>
      <div class="nav-item" data-view="new-encounter" onclick="navigate('new-encounter')">
        <span class="nav-icon">üìã</span> New Encounter
      </div>
      <div class="nav-section-label">Management</div>
      <div class="nav-item" data-view="appointments" onclick="navigate('appointments')">
        <span class="nav-icon">üìÖ</span> Appointments
      </div>
      <div class="nav-item" data-view="consent-requests" onclick="navigate('consent-requests')">
        <span class="nav-icon">üîî</span> Consent Requests
        <span class="nav-badge hidden" id="consent-badge">0</span>
      </div>
      <div class="nav-section-label">Governance</div>
      <div class="nav-item" data-view="audit-log" onclick="navigate('audit-log')">
        <span class="nav-icon">üóÇÔ∏è</span> Audit Log
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="facility-badge" id="sb-facility">Kamuzu Central Hospital</div>
      <button class="btn btn-ghost btn-full" style="margin-top:10px;font-size:12px;" onclick="doLogout()">Sign Out</button>
    </div>
  </nav>

  <!-- Main content area -->
  <div class="main-content">
    <!-- Session bar (shown when session active) -->
    <div id="session-bar" class="session-bar hidden">
      <span>üîì ACTIVE SESSION</span>
      <span>Patient: <strong id="session-patient-name"></strong></span>
      <span>Scope: <span id="session-scope-display"></span></span>
      <span class="timer" id="session-timer">03:59:00</span>
      <button class="btn btn-danger" style="margin-left:auto;padding:6px 14px;font-size:12px;" onclick="revokeCurrentSession()">Revoke Access</button>
    </div>

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div id="view-dashboard">
      <div class="page-header">
        <div><h2>Dashboard</h2><p id="dash-greeting">Good morning, Doctor</p></div>
        <div style="font-size:12px;color:var(--gray-400);" id="dash-datetime"></div>
      </div>
      <div class="page-body">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--lightblue);">üë•</div>
            <div class="stat-label">Patients Today</div>
            <div class="stat-value" id="stat-today">0</div>
            <div class="stat-sub">Encounters recorded</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--green-light);">‚úÖ</div>
            <div class="stat-label">Active Consents</div>
            <div class="stat-value" id="stat-consents">0</div>
            <div class="stat-sub">Live access tokens</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--amber-light);">‚è≥</div>
            <div class="stat-label">Pending Consent</div>
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-sub">Awaiting patient approval</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:#EDE9FE;">üìã</div>
            <div class="stat-label">Records Created</div>
            <div class="stat-value" id="stat-records">0</div>
            <div class="stat-sub">This session</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div class="card">
            <div class="card-header"><h3>Recent Activity</h3></div>
            <div class="card-body" style="padding:0;">
              <div id="dash-activity" style="padding:16px 24px;"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Quick Actions</h3></div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:10px;">
              <button class="btn btn-primary btn-full" onclick="navigate('patient-search')">üîç &nbsp;Look Up Patient</button>
              <button class="btn btn-success btn-full" onclick="navigate('new-encounter')">üìã &nbsp;New Encounter Report</button>
              <button class="btn btn-ghost btn-full" onclick="navigate('appointments')">üìÖ &nbsp;View Appointments</button>
              <button class="btn btn-ghost btn-full" onclick="navigate('audit-log')">üóÇÔ∏è &nbsp;View Audit Log</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:20px;">
          <div class="card-header"><h3>üèõÔ∏è Core Switchboard Status</h3></div>
          <div class="card-body">
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center;">
              <div>
                <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Routing Engine</div>
                <div style="font-size:13px;color:var(--green);font-weight:700;margin-top:6px;">‚óè ONLINE</div>
              </div>
              <div>
                <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Consent Module</div>
                <div style="font-size:13px;color:var(--green);font-weight:700;margin-top:6px;">‚óè ONLINE</div>
              </div>
              <div>
                <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">FHIR Gateway</div>
                <div style="font-size:13px;color:var(--green);font-weight:700;margin-top:6px;">‚óè ONLINE</div>
              </div>
              <div>
                <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">MNID Directory</div>
                <div style="font-size:13px;color:var(--green);font-weight:700;margin-top:6px;">‚óè ONLINE</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PATIENT LOOKUP ‚îÄ‚îÄ -->
    <div id="view-patient-search" class="hidden">
      <div class="page-header">
        <div><h2>Patient Lookup</h2><p>Search by Malawi National ID (MNID) to retrieve patient</p></div>
      </div>
      <div class="page-body">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-body">
            <div style="display:flex;gap:12px;">
              <div class="search-box" style="flex:1;">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-mnid" placeholder="Enter MNID (e.g. MW-12345678) or patient name..." style="width:100%;" onkeydown="if(event.key==='Enter')searchPatient()">
              </div>
              <button class="btn btn-primary" onclick="searchPatient()">Search</button>
            </div>
            <p style="font-size:11px;color:var(--gray-400);margin-top:8px;">
              ‚ÑπÔ∏è Three-factor verification will be performed: MNID hash match ¬∑ Date of birth confirmation ¬∑ Active consent token
            </p>
          </div>
        </div>

        <div id="search-results" class="hidden">
          <!-- populated dynamically -->
        </div>

        <div id="patient-profile-view" class="hidden">
          <!-- populated dynamically -->
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ACTIVE SESSION ‚îÄ‚îÄ -->
    <div id="view-active-session" class="hidden">
      <div class="page-header">
        <div><h2>Active Session</h2><p>Patient records accessible within this consent window</p></div>
      </div>
      <div class="page-body" id="active-session-content">
        <div class="empty-state">
          <div class="icon">üîí</div>
          <p>No active session. Use Patient Lookup to request consent and open a session.</p>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ NEW ENCOUNTER ‚îÄ‚îÄ -->
    <div id="view-new-encounter" class="hidden">
      <div class="page-header">
        <div><h2>New Encounter Report</h2><p>Document clinical findings ‚Äî record will be written to facility database and QR issued to patient</p></div>
      </div>
      <div class="page-body">
        <div class="card">
          <div class="card-header"><h3>Patient Information</h3></div>
          <div class="card-body">
            <div id="encounter-alert" class="hidden"></div>
            <div class="form-grid">
              <div class="form-group">
                <label>Patient MNID *</label>
                <input type="text" id="enc-mnid" placeholder="MW-XXXXXXXX">
              </div>
              <div class="form-group">
                <label>Date of Birth (verification) *</label>
                <input type="date" id="enc-dob">
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header"><h3>Clinical Details</h3></div>
          <div class="card-body">
            <div class="form-grid">
              <div class="form-group">
                <label>Record Type *</label>
                <select id="enc-type">
                  <option value="encounter_summary">Encounter Summary</option>
                  <option value="lab_result">Lab Result</option>
                  <option value="prescription">Prescription / Medication</option>
                  <option value="vaccination">Vaccination Record</option>
                  <option value="observation">Clinical Observation</option>
                  <option value="referral">Referral</option>
                </select>
              </div>
              <div class="form-group">
                <label>Visit Date *</label>
                <input type="date" id="enc-date">
              </div>
            </div>
            <div class="form-group">
              <label>Primary Diagnosis / Condition (ICD-10 code optional)</label>
              <input type="text" id="enc-diagnosis" placeholder="e.g. Malaria (B54), Hypertension (I10), Antenatal visit (Z34.0)">
            </div>
            <div class="form-group">
              <label>Medications / Prescriptions</label>
              <input type="text" id="enc-medications" placeholder="e.g. Artemether-Lumefantrine 20/120mg, Paracetamol 500mg">
            </div>
            <div class="form-group">
              <label>Allergies (if new or updated)</label>
              <input type="text" id="enc-allergies" placeholder="e.g. Penicillin, Sulfonamides, None known">
            </div>
            <div class="form-group col-span-2">
              <label>Clinical Notes</label>
              <textarea id="enc-notes" rows="4" placeholder="Subjective findings, objective measurements, assessment and plan..."></textarea>
            </div>
            <div class="form-group">
              <label>Vital Signs</label>
              <div class="form-grid-3">
                <input type="text" id="enc-bp" placeholder="BP (mmHg) e.g. 120/80">
                <input type="text" id="enc-temp" placeholder="Temp (¬∞C)">
                <input type="text" id="enc-weight" placeholder="Weight (kg)">
              </div>
            </div>
            <div class="form-group">
              <label>Follow-up Required</label>
              <select id="enc-followup">
                <option value="none">No follow-up needed</option>
                <option value="1week">1 week</option>
                <option value="2weeks">2 weeks</option>
                <option value="1month">1 month</option>
                <option value="3months">3 months</option>
                <option value="antenatal">Antenatal schedule</option>
                <option value="hivart">HIV/ART protocol</option>
              </select>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:20px;">
          <button class="btn btn-success" style="flex:1;justify-content:center;padding:14px;" onclick="saveEncounter()">
            üíæ &nbsp;Save to Facility Database &amp; Generate QR
          </button>
          <button class="btn btn-ghost" onclick="clearEncounterForm()">Clear</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ APPOINTMENTS ‚îÄ‚îÄ -->
    <div id="view-appointments" class="hidden">
      <div class="page-header">
        <div><h2>Appointments</h2><p>Manage patient scheduling across facilities</p></div>
      </div>
      <div class="page-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div class="card">
            <div class="card-header"><h3>Today's Schedule</h3></div>
            <div class="card-body" id="today-appointments"></div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Book New Appointment</h3></div>
            <div class="card-body">
              <div class="form-group">
                <label>Patient MNID</label>
                <input type="text" id="appt-mnid" placeholder="MW-XXXXXXXX">
              </div>
              <div class="form-group">
                <label>Date</label>
                <input type="date" id="appt-date">
              </div>
              <div class="form-group">
                <label>Time Slot</label>
                <select id="appt-time">
                  <option>08:00 ‚Äì 08:30</option><option>08:30 ‚Äì 09:00</option>
                  <option>09:00 ‚Äì 09:30</option><option>09:30 ‚Äì 10:00</option>
                  <option>10:00 ‚Äì 10:30</option><option>10:30 ‚Äì 11:00</option>
                  <option>14:00 ‚Äì 14:30</option><option>14:30 ‚Äì 15:00</option>
                  <option>15:00 ‚Äì 15:30</option>
                </select>
              </div>
              <div class="form-group">
                <label>Appointment Type</label>
                <select id="appt-type">
                  <option>General OPD</option><option>Antenatal Care (ANC)</option>
                  <option>HIV/ART Review</option><option>Child Welfare</option>
                  <option>Specialist Referral</option><option>Follow-up</option>
                </select>
              </div>
              <button class="btn btn-primary btn-full" onclick="bookAppointment()">üìÖ Book Appointment</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ CONSENT REQUESTS ‚îÄ‚îÄ -->
    <div id="view-consent-requests" class="hidden">
      <div class="page-header">
        <div><h2>Consent Requests</h2><p>Track all consent requests you have initiated</p></div>
      </div>
      <div class="page-body">
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table class="data-table" id="consent-table">
              <thead>
                <tr>
                  <th>Patient MNID</th>
                  <th>Scope Requested</th>
                  <th>Status</th>
                  <th>Requested</th>
                  <th>Expires</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="consent-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ AUDIT LOG ‚îÄ‚îÄ -->
    <div id="view-audit-log" class="hidden">
      <div class="page-header">
        <div><h2>Audit Log</h2><p>Immutable record of all data access events ‚Äî no medical content stored</p></div>
      </div>
      <div class="page-body">
        <div class="alert alert-info">
          üîí This log is append-only and cryptographically hash-chained. Every entry is recorded before data is transmitted. MNID values are stored as one-way SHA-256 hashes only.
        </div>
        <div class="card">
          <div class="card-body" style="padding:0 24px;" id="audit-log-content"></div>
        </div>
      </div>
    </div>

  </div><!-- end main-content -->
</div><!-- end screen-main -->

<!-- QR Modal -->
<div id="qr-modal-overlay" class="qr-modal-overlay hidden">
  <div class="qr-modal">
    <h3>üì± QR Record Transfer</h3>
    <p>Ask the patient to open their Chipatala Connect app and scan this QR code to receive their record.</p>
    <div id="qr-canvas-container"></div>
    <div class="qr-payload-preview" id="qr-payload-preview"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-primary btn-full" onclick="closeQR()">‚úì Patient Scanned ‚Äî Done</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  get: k => { try { return JSON.parse(localStorage.getItem('cc_' + k) || 'null'); } catch { return null; } },
  set: (k, v) => localStorage.setItem('cc_' + k, JSON.stringify(v)),
  push: (k, item) => {
    const arr = DB.get(k) || [];
    arr.push(item);
    DB.set(k, arr);
    return item;
  }
};

let currentDoctor = null;
let currentView = 'dashboard';
let activeSession = null;
let sessionTimerInterval = null;
let sessionSecondsLeft = 0;

const DOCTORS = [
  { id: 'DR-001', name: 'Dr. Amara Banda', specialty: 'Internal Medicine', facility_id: 'KCH-001', facility_name: 'Kamuzu Central Hospital', username: 'DR-001', password: 'password123' },
  { id: 'DR-002', name: 'Dr. Sarah Chirwa', specialty: 'Obstetrics & Gynaecology', facility_id: 'QECH-002', facility_name: 'Queen Elizabeth Central Hospital', username: 'DR-002', password: 'password123' },
  { id: 'DR-003', name: 'Dr. James Mwale', specialty: 'Paediatrics', facility_id: 'DHO-MLJ-003', facility_name: 'Mchinji District Hospital', username: 'DR-003', password: 'password123' },
];

// Seed initial data if not present
function seedData() {
  if (DB.get('seeded')) return;

  const patients = [
    { id: 'PT-001', mnid: 'MW-12345678', name: 'Grace Phiri', dob: '1992-03-15', phone: '+265991234567', tier: 1, registered_at: '2024-01-10', facilities: ['KCH-001', 'DHO-MLJ-003'], pin_hash: '1234' },
    { id: 'PT-002', mnid: 'MW-87654321', name: 'John Kalonga', dob: '1985-11-20', phone: '+265881234567', tier: 1, registered_at: '2024-02-14', facilities: ['QECH-002'], pin_hash: '1234' },
    { id: 'PT-003', mnid: 'MW-11223344', name: 'Mercy Tembo', dob: '2000-07-08', phone: '+265991122334', tier: 1, registered_at: '2024-03-01', facilities: ['KCH-001'], pin_hash: '1234' },
    { id: 'PT-004', mnid: 'MW-55667788', name: 'Samuel Nkosi', dob: '1978-04-25', phone: '+265881234890', tier: 1, registered_at: '2024-04-05', facilities: ['KCH-001', 'QECH-002'], pin_hash: '1234' },
  ];

  const records = [
    { id: 'REC-001', patient_mnid: 'MW-12345678', record_type: 'encounter_summary', facility_id: 'KCH-001', facility_name: 'Kamuzu Central Hospital', doctor_id: 'DR-001', doctor_name: 'Dr. Amara Banda', created_at: '2025-03-10T09:30:00Z', diagnosis: 'Malaria (B54) - Uncomplicated', medications: 'Artemether-Lumefantrine 20/120mg √ó 6 doses', notes: 'Patient presented with 3-day fever. RDT positive for Plasmodium falciparum. Prescribed AL per national protocol.', allergies: 'None known', vitals: { bp: '118/76', temp: '38.4¬∞C', weight: '62kg' }, followup: '1week', synced_to_device: true },
    { id: 'REC-002', patient_mnid: 'MW-12345678', record_type: 'vaccination', facility_id: 'DHO-MLJ-003', facility_name: 'Mchinji District Hospital', doctor_id: 'DR-003', doctor_name: 'Dr. James Mwale', created_at: '2025-01-15T11:00:00Z', diagnosis: 'Tetanus Toxoid (TT) Booster', medications: 'Tetanus Toxoid 0.5ml IM', notes: 'Routine TT booster. No adverse reaction.', allergies: '', vitals: {}, followup: 'none', synced_to_device: true },
    { id: 'REC-003', patient_mnid: 'MW-87654321', record_type: 'prescription', facility_id: 'QECH-002', facility_name: 'Queen Elizabeth Central Hospital', doctor_id: 'DR-002', doctor_name: 'Dr. Sarah Chirwa', created_at: '2025-02-20T14:15:00Z', diagnosis: 'Hypertension (I10)', medications: 'Amlodipine 5mg OD, Enalapril 10mg BD', notes: 'BP well controlled. Continue current regimen. Lifestyle advice given.', allergies: 'ACE inhibitor cough noted ‚Äî monitor', vitals: { bp: '132/84', temp: '36.8¬∞C', weight: '78kg' }, followup: '3months', synced_to_device: true },
    { id: 'REC-004', patient_mnid: 'MW-11223344', record_type: 'encounter_summary', facility_id: 'KCH-001', facility_name: 'Kamuzu Central Hospital', doctor_id: 'DR-001', doctor_name: 'Dr. Amara Banda', created_at: '2025-04-05T08:45:00Z', diagnosis: 'Antenatal visit (Z34.0) ‚Äî 28 weeks', medications: 'Ferrous sulphate 200mg BD, Folic acid 5mg OD', notes: 'Routine ANC visit. Fundal height 28cm. FHR 148bpm. No complications.', allergies: 'None known', vitals: { bp: '110/70', temp: '36.5¬∞C', weight: '70kg' }, followup: 'antenatal', synced_to_device: false },
    { id: 'REC-005', patient_mnid: 'MW-55667788', record_type: 'lab_result', facility_id: 'KCH-001', facility_name: 'Kamuzu Central Hospital', doctor_id: 'DR-001', doctor_name: 'Dr. Amara Banda', created_at: '2025-05-01T10:00:00Z', diagnosis: 'HIV Viral Load Test ‚Äî Suppressed', medications: 'Continue current ART regimen', notes: 'VL < 50 copies/mL. Patient virally suppressed. Good adherence reported. Next VL in 12 months.', allergies: 'Nevirapine (rash ‚Äî switched to Efavirenz)', vitals: { bp: '124/80', temp: '36.9¬∞C', weight: '71kg' }, followup: 'hivart', synced_to_device: true },
  ];

  const audit = [
    { event_id: 'AUD-001', event_type: 'RECORD_CREATED', timestamp: '2025-03-10T09:30:00Z', patient_mnid_hash: hashMnid('MW-12345678'), requesting_facility: 'KCH-001', requesting_clinician: 'DR-001', scope: ['encounter_summary'], outcome: 'SUCCESS' },
    { event_id: 'AUD-002', event_type: 'CONSENT_GRANTED', timestamp: '2025-04-05T08:40:00Z', patient_mnid_hash: hashMnid('MW-11223344'), requesting_facility: 'KCH-001', requesting_clinician: 'DR-001', scope: ['observations', 'medications'], outcome: 'SUCCESS' },
    { event_id: 'AUD-003', event_type: 'CROSS_FACILITY_ACCESS', timestamp: '2025-05-01T09:55:00Z', patient_mnid_hash: hashMnid('MW-55667788'), requesting_facility: 'KCH-001', requesting_clinician: 'DR-001', source_facility: 'QECH-002', scope: ['medications', 'allergies'], outcome: 'SUCCESS' },
  ];

  DB.set('patients', patients);
  DB.set('records', records);
  DB.set('audit_log', audit);
  DB.set('consent_requests', []);
  DB.set('appointments', []);
  DB.set('qr_pending', []);
  DB.set('seeded', true);
}

function hashMnid(mnid) {
  // Simplified hash simulation
  let h = 0;
  for (let c of mnid) h = (Math.imul(31, h) + c.charCodeAt(0)) | 0;
  return 'sha256:' + Math.abs(h).toString(16).padStart(8, '0') + '...';
}

function uuid() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const facilityId = document.getElementById('login-facility').value;

  const doctor = DOCTORS.find(d => d.username === username && d.password === password);
  if (!doctor) {
    const err = document.getElementById('login-error');
    err.textContent = '‚ö†Ô∏è Invalid credentials. Try DR-001 / password123';
    err.classList.remove('hidden');
    return;
  }

  currentDoctor = { ...doctor, facility_id: facilityId };
  const fac = document.getElementById('login-facility');
  currentDoctor.facility_name = fac.options[fac.selectedIndex].text;

  seedData();
  showMainScreen();
}

function doLogout() {
  if (sessionTimerInterval) clearInterval(sessionTimerInterval);
  activeSession = null;
  currentDoctor = null;
  document.getElementById('screen-main').classList.add('hidden');
  document.getElementById('screen-login').classList.remove('hidden');
}

function showMainScreen() {
  document.getElementById('screen-login').classList.add('hidden');
  document.getElementById('screen-main').classList.remove('hidden');

  document.getElementById('sb-name').textContent = currentDoctor.name;
  document.getElementById('sb-role').textContent = currentDoctor.specialty;
  document.getElementById('sb-facility').textContent = currentDoctor.facility_name;
  document.getElementById('sb-avatar').textContent = currentDoctor.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();

  const enc = document.getElementById('enc-date');
  enc.value = new Date().toISOString().slice(0, 10);

  navigate('dashboard');
  updateBadges();
  setInterval(updateBadges, 5000);
  setInterval(updateDateTime, 1000);
  updateDateTime();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navigate(view) {
  document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + view).classList.remove('hidden');
  document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');
  currentView = view;

  if (view === 'dashboard') renderDashboard();
  if (view === 'consent-requests') renderConsentRequests();
  if (view === 'audit-log') renderAuditLog();
  if (view === 'active-session') renderActiveSession();
  if (view === 'appointments') renderAppointments();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const records = DB.get('records') || [];
  const consents = DB.get('consent_requests') || [];
  const myRecords = records.filter(r => r.doctor_id === currentDoctor.id);
  const activeConsents = consents.filter(c => c.doctor_id === currentDoctor.id && c.status === 'ACTIVE');
  const pendingConsents = consents.filter(c => c.doctor_id === currentDoctor.id && c.status === 'PENDING');

  document.getElementById('stat-today').textContent = myRecords.filter(r => r.created_at.startsWith(new Date().toISOString().slice(0,10))).length;
  document.getElementById('stat-consents').textContent = activeConsents.length + (activeSession ? 1 : 0);
  document.getElementById('stat-pending').textContent = pendingConsents.length;
  document.getElementById('stat-records').textContent = myRecords.length;

  const greet = new Date().getHours() < 12 ? 'Good morning' : new Date().getHours() < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('dash-greeting').textContent = `${greet}, ${currentDoctor.name.split(' ')[1] || 'Doctor'}`;

  const audit = (DB.get('audit_log') || []).slice(-5).reverse();
  const actEl = document.getElementById('dash-activity');
  if (!audit.length) { actEl.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>'; return; }
  actEl.innerHTML = audit.map(a => `
    <div class="audit-row">
      <div class="audit-event-icon" style="background:${a.outcome==='SUCCESS'?'var(--green-light)':'var(--red-light)'};">
        ${a.event_type === 'RECORD_CREATED' ? 'üìã' : a.event_type === 'CONSENT_GRANTED' ? '‚úÖ' : a.event_type === 'CROSS_FACILITY_ACCESS' ? 'üîÅ' : 'üîî'}
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--gray-800);">${a.event_type.replace(/_/g,' ')}</div>
        <div style="font-size:11px;color:var(--gray-400);">${new Date(a.timestamp).toLocaleString()}</div>
      </div>
      <span class="badge ${a.outcome==='SUCCESS'?'badge-active':'badge-revoked'}" style="margin-left:auto;">${a.outcome}</span>
    </div>
  `).join('');
}

function updateDateTime() {
  const el = document.getElementById('dash-datetime');
  if (el) el.textContent = new Date().toLocaleString('en-GB', { dateStyle: 'full', timeStyle: 'medium' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATIENT SEARCH & PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function searchPatient() {
  const q = document.getElementById('search-mnid').value.trim().toUpperCase();
  if (!q) return toast('Enter an MNID or patient name', 'warning');

  const patients = DB.get('patients') || [];
  const results = patients.filter(p =>
    p.mnid.toUpperCase().includes(q) ||
    p.name.toUpperCase().includes(q)
  );

  const el = document.getElementById('search-results');
  el.classList.remove('hidden');

  if (!results.length) {
    el.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è No patients found matching "<strong>${q}</strong>". Verify the MNID with the National Registration Bureau directory.</div>`;
    return;
  }

  el.innerHTML = `
    <div class="card">
      <div class="card-header"><h3>Search Results (${results.length})</h3></div>
      <div class="card-body" style="padding:0;">
        <table class="data-table">
          <thead><tr><th>MNID</th><th>Name</th><th>Date of Birth</th><th>Registered Facilities</th><th>ID Tier</th><th>Action</th></tr></thead>
          <tbody>
            ${results.map(p => `
              <tr>
                <td><code style="font-size:12px;color:var(--navy);">${p.mnid}</code></td>
                <td><strong>${p.name}</strong></td>
                <td>${p.dob}</td>
                <td>${p.facilities.join(', ')}</td>
                <td><span class="badge badge-info">Tier ${p.tier} ‚Äî MNID</span></td>
                <td><button class="btn btn-primary" style="padding:6px 12px;font-size:12px;" onclick="openPatientProfile('${p.mnid}')">Open Profile</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function openPatientProfile(mnid) {
  const patients = DB.get('patients') || [];
  const p = patients.find(x => x.mnid === mnid);
  if (!p) return;

  document.getElementById('search-results').classList.add('hidden');
  const profileEl = document.getElementById('patient-profile-view');
  profileEl.classList.remove('hidden');

  // Check if there's an active session for this patient
  const consentReqs = DB.get('consent_requests') || [];
  const existingActive = consentReqs.find(c => c.patient_mnid === mnid && c.doctor_id === currentDoctor.id && c.status === 'ACTIVE' && new Date(c.expires_at) > new Date());
  const existingPending = consentReqs.find(c => c.patient_mnid === mnid && c.doctor_id === currentDoctor.id && c.status === 'PENDING');

  let sessionSection = '';
  if (activeSession && activeSession.patient_mnid === mnid) {
    sessionSection = `<div class="alert alert-success" style="margin-bottom:16px;">‚úÖ <strong>Active session open.</strong> Records are accessible below.</div>`;
  } else if (existingPending) {
    sessionSection = `<div class="alert alert-warning" style="margin-bottom:16px;">‚è≥ <strong>Consent request pending</strong> ‚Äî waiting for patient to approve in their app. Request ID: <code>${existingPending.id.slice(0,8)}</code></div>`;
  } else if (existingActive) {
    sessionSection = `<div class="alert alert-success" style="margin-bottom:16px;">‚úÖ <strong>Consent active.</strong> <a href="#" onclick="navigate('active-session')" style="color:var(--green);">Open session view ‚Üí</a></div>`;
  } else {
    sessionSection = `
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header"><h3>üîê Request Data Access</h3></div>
        <div class="card-body">
          <p style="font-size:13px;color:var(--gray-600);margin-bottom:16px;">
            Select the data scope you need. A consent notification will be sent to the patient's app/USSD.
          </p>
          <div class="form-group">
            <label>Data Scope</label>
            <div class="scope-options">
              <label class="scope-chip checked" onclick="toggleScope(this,'observations')"><input type="checkbox" checked>üî¨ Observations</label>
              <label class="scope-chip checked" onclick="toggleScope(this,'medications')"><input type="checkbox" checked>üíä Medications</label>
              <label class="scope-chip checked" onclick="toggleScope(this,'allergies')"><input type="checkbox" checked>‚ö†Ô∏è Allergies</label>
              <label class="scope-chip" onclick="toggleScope(this,'lab_results')"><input type="checkbox">üß™ Lab Results</label>
              <label class="scope-chip" onclick="toggleScope(this,'vaccinations')"><input type="checkbox">üíâ Vaccinations</label>
              <label class="scope-chip" onclick="toggleScope(this,'full_history')"><input type="checkbox">üìÇ Full History</label>
            </div>
          </div>
          <div class="form-group">
            <label>Date of Birth Verification *</label>
            <input type="date" id="dob-verify-${mnid}" placeholder="Enter patient DOB to verify identity">
            <p style="font-size:11px;color:var(--gray-400);margin-top:4px;">Required: Three-factor verification (MNID + DOB + consent)</p>
          </div>
          <button class="btn btn-primary" onclick="requestConsent('${mnid}')">üì§ &nbsp;Send Consent Request to Patient</button>
        </div>
      </div>
    `;
  }

  profileEl.innerHTML = `
    <div class="card">
      <div class="patient-header">
        <div class="patient-avatar">${p.name.split(' ').map(w=>w[0]).join('').slice(0,2)}</div>
        <div class="patient-info">
          <div class="name">${p.name}</div>
          <div class="mnid">${p.mnid}</div>
          <div class="meta">DOB: ${p.dob} &nbsp;¬∑&nbsp; Phone: ${p.phone} &nbsp;¬∑&nbsp; Tier 1 ‚Äî MNID Verified</div>
        </div>
        <button class="btn btn-ghost" style="margin-left:auto;color:white;border-color:rgba(255,255,255,.4);" onclick="document.getElementById('patient-profile-view').classList.add('hidden');document.getElementById('search-mnid').value='';">‚úï Close</button>
      </div>
      <div class="card-body">
        ${sessionSection}
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
          <div style="padding:12px;background:var(--gray-50);border-radius:var(--radius);border:1px solid var(--gray-200);">
            <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Registered Facilities</div>
            <div style="font-size:13px;font-weight:700;margin-top:4px;">${p.facilities.length}</div>
            <div style="font-size:11px;color:var(--gray-400);">${p.facilities.join(' ¬∑ ')}</div>
          </div>
          <div style="padding:12px;background:var(--gray-50);border-radius:var(--radius);border:1px solid var(--gray-200);">
            <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Total Records</div>
            <div style="font-size:13px;font-weight:700;margin-top:4px;">${(DB.get('records')||[]).filter(r=>r.patient_mnid===mnid).length}</div>
            <div style="font-size:11px;color:var(--gray-400);">Across all facilities</div>
          </div>
          <div style="padding:12px;background:var(--gray-50);border-radius:var(--radius);border:1px solid var(--gray-200);">
            <div style="font-size:11px;color:var(--gray-600);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Identity Tier</div>
            <div style="font-size:13px;font-weight:700;margin-top:4px;color:var(--green);">Tier 1 ‚Äî MNID</div>
            <div style="font-size:11px;color:var(--gray-400);">National Registration Bureau</div>
          </div>
        </div>
        ${(activeSession && activeSession.patient_mnid === mnid) ? renderPatientRecords(mnid) : ''}
      </div>
    </div>
  `;
}

function toggleScope(label, scope) {
  label.classList.toggle('checked');
}

function getSelectedScopes() {
  return Array.from(document.querySelectorAll('.scope-chip.checked')).map(el => {
    const text = el.textContent.trim().replace(/^[^\s]+\s/, '');
    return text.toLowerCase().replace(/\s+/g, '_');
  });
}

function requestConsent(mnid) {
  const patients = DB.get('patients') || [];
  const p = patients.find(x => x.mnid === mnid);
  if (!p) return;

  const dobInput = document.getElementById(`dob-verify-${mnid}`);
  if (!dobInput.value) return toast('Please enter patient date of birth for verification', 'warning');
  if (dobInput.value !== p.dob) return toast('‚ö†Ô∏è DOB verification failed ‚Äî does not match MNID record', 'error');

  const scopes = getSelectedScopes();
  if (!scopes.length) return toast('Select at least one data scope', 'warning');

  const reqId = uuid();
  const req = {
    id: reqId,
    patient_mnid: mnid,
    patient_name: p.name,
    doctor_id: currentDoctor.id,
    doctor_name: currentDoctor.name,
    facility_id: currentDoctor.facility_id,
    facility_name: currentDoctor.facility_name,
    scope: scopes,
    status: 'PENDING',
    created_at: new Date().toISOString(),
    expires_at: null,
    token_id: null
  };

  DB.push('consent_requests', req);
  addAuditLog('CONSENT_REQUESTED', mnid, scopes, 'PENDING');
  toast('üì§ Consent request sent to patient. Waiting for approval...', 'success');
  openPatientProfile(mnid); // re-render
  updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function activateSession(requestId) {
  const reqs = DB.get('consent_requests') || [];
  const req = reqs.find(r => r.id === requestId);
  if (!req || req.status !== 'PENDING') return;

  const tokenId = uuid();
  const expiresAt = new Date(Date.now() + 4 * 60 * 60 * 1000).toISOString(); // 4 hours

  req.status = 'ACTIVE';
  req.expires_at = expiresAt;
  req.token_id = tokenId;
  DB.set('consent_requests', reqs);

  activeSession = {
    request_id: requestId,
    token_id: tokenId,
    patient_mnid: req.patient_mnid,
    patient_name: req.patient_name,
    doctor_id: req.doctor_id,
    scope: req.scope,
    expires_at: expiresAt
  };

  startSessionTimer();
  addAuditLog('CONSENT_GRANTED', req.patient_mnid, req.scope, 'SUCCESS');
  toast(`‚úÖ Consent granted by ${req.patient_name}. Session opened.`, 'success');
  updateBadges();
  navigate('active-session');
}

function startSessionTimer() {
  if (sessionTimerInterval) clearInterval(sessionTimerInterval);
  sessionSecondsLeft = 4 * 60 * 60;

  const bar = document.getElementById('session-bar');
  const timer = document.getElementById('session-timer');
  bar.classList.remove('hidden', 'expiring', 'critical');

  document.getElementById('session-patient-name').textContent = activeSession.patient_name;
  document.getElementById('session-scope-display').textContent = activeSession.scope.join(', ');

  sessionTimerInterval = setInterval(() => {
    sessionSecondsLeft--;
    const h = Math.floor(sessionSecondsLeft / 3600).toString().padStart(2, '0');
    const m = Math.floor((sessionSecondsLeft % 3600) / 60).toString().padStart(2, '0');
    const s = (sessionSecondsLeft % 60).toString().padStart(2, '0');
    timer.textContent = `${h}:${m}:${s}`;

    bar.classList.remove('expiring', 'critical');
    if (sessionSecondsLeft < 300) bar.classList.add('critical');
    else if (sessionSecondsLeft < 900) bar.classList.add('expiring');

    if (sessionSecondsLeft <= 0) expireSession();
  }, 1000);
}

function expireSession() {
  clearInterval(sessionTimerInterval);
  const oldSession = activeSession;
  if (oldSession) {
    addAuditLog('SESSION_EXPIRED', oldSession.patient_mnid, oldSession.scope, 'EXPIRED');
    const reqs = DB.get('consent_requests') || [];
    const req = reqs.find(r => r.id === oldSession.request_id);
    if (req) { req.status = 'EXPIRED'; DB.set('consent_requests', reqs); }
  }
  activeSession = null;
  document.getElementById('session-bar').classList.add('hidden');
  clearActiveDomData();
  toast('‚è± Session expired ‚Äî patient data has been cleared from portal', 'warning');
  updateBadges();
}

function revokeCurrentSession() {
  if (!activeSession) return;
  if (!confirm('Revoke this consent session? Patient data will be immediately cleared from the portal.')) return;
  clearInterval(sessionTimerInterval);
  addAuditLog('CONSENT_REVOKED', activeSession.patient_mnid, activeSession.scope, 'REVOKED');
  const reqs = DB.get('consent_requests') || [];
  const req = reqs.find(r => r.id === activeSession.request_id);
  if (req) { req.status = 'REVOKED'; DB.set('consent_requests', reqs); }
  activeSession = null;
  document.getElementById('session-bar').classList.add('hidden');
  clearActiveDomData();
  toast('üîí Session revoked ‚Äî all patient data cleared', 'success');
  updateBadges();
  navigate('dashboard');
}

function clearActiveDomData() {
  document.getElementById('active-session-content').innerHTML = `
    <div class="empty-state"><div class="icon">üîí</div><p>Session ended. All patient data has been purged from memory.</p></div>`;
}

function renderActiveSession() {
  const el = document.getElementById('active-session-content');
  if (!activeSession) {
    el.innerHTML = `<div class="empty-state"><div class="icon">üîí</div><p>No active session. Use Patient Lookup to request consent.</p></div>`;
    return;
  }
  el.innerHTML = `
    <div class="alert alert-info" style="margin-bottom:20px;">
      üîì <strong>Active session for ${activeSession.patient_name}</strong> ‚Äî scope: ${activeSession.scope.join(', ')}
      ‚Äî expires: ${new Date(activeSession.expires_at).toLocaleTimeString()}
    </div>
    ${renderPatientRecords(activeSession.patient_mnid)}
  `;
}

function renderPatientRecords(mnid) {
  const records = (DB.get('records') || []).filter(r => r.patient_mnid === mnid);
  if (!records.length) return `<div class="empty-state"><div class="icon">üìÇ</div><p>No records found for this patient.</p></div>`;

  const icons = { encounter_summary: 'ü©∫', lab_result: 'üß™', prescription: 'üíä', vaccination: 'üíâ', observation: 'üìä', referral: '‚ÜóÔ∏è' };
  const iconClass = { encounter_summary: 'encounter', lab_result: 'lab', prescription: 'prescription', vaccination: 'vaccination' };

  return `
    <h4 style="font-size:14px;font-weight:700;color:var(--navy);margin-bottom:12px;">Patient Records (${records.length})</h4>
    ${records.map((r, i) => `
      <div class="record-card" id="rec-card-${i}">
        <div class="record-card-header" onclick="toggleRecord(${i})">
          <div class="record-icon ${iconClass[r.record_type]||'encounter'}">${icons[r.record_type]||'üìã'}</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:var(--gray-800);">${r.diagnosis}</div>
            <div style="font-size:11px;color:var(--gray-400);">${new Date(r.created_at).toLocaleDateString()} ¬∑ ${r.facility_name} ¬∑ ${r.doctor_name}</div>
          </div>
          <span class="badge badge-info">${r.record_type.replace(/_/g,' ')}</span>
          <span style="color:var(--gray-400);margin-left:8px;">${document.getElementById('rec-card-'+i)?.classList.contains('expanded') ? '‚ñ≤' : '‚ñº'}</span>
        </div>
        <div class="record-card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--gray-600);text-transform:uppercase;margin-bottom:4px;">Diagnosis</div>
              <div style="font-size:13px;">${r.diagnosis}</div>
            </div>
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--gray-600);text-transform:uppercase;margin-bottom:4px;">Medications</div>
              <div style="font-size:13px;">${r.medications || '‚Äî'}</div>
            </div>
            ${r.allergies ? `<div>
              <div style="font-size:11px;font-weight:700;color:var(--red);text-transform:uppercase;margin-bottom:4px;">‚ö†Ô∏è Allergies</div>
              <div style="font-size:13px;color:var(--red);">${r.allergies}</div>
            </div>` : ''}
            ${Object.keys(r.vitals||{}).length ? `<div>
              <div style="font-size:11px;font-weight:700;color:var(--gray-600);text-transform:uppercase;margin-bottom:4px;">Vital Signs</div>
              <div style="font-size:12px;">${Object.entries(r.vitals).map(([k,v])=>`<span style="margin-right:8px;"><strong>${k.toUpperCase()}:</strong> ${v}</span>`).join('')}</div>
            </div>` : ''}
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--gray-600);text-transform:uppercase;margin-bottom:4px;">Clinical Notes</div>
            <div style="font-size:13px;color:var(--gray-800);">${r.notes}</div>
          </div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--gray-100);">
            <div style="font-size:11px;color:var(--gray-400);">FHIR Resources:</div>
            <div style="margin-top:4px;">
              <span class="fhir-tag">Encounter</span>
              <span class="fhir-tag">Condition</span>
              ${r.medications ? '<span class="fhir-tag">MedicationRequest</span>' : ''}
              ${r.allergies ? '<span class="fhir-tag">AllergyIntolerance</span>' : ''}
              ${r.record_type === 'lab_result' ? '<span class="fhir-tag">DiagnosticReport</span>' : ''}
              ${r.record_type === 'vaccination' ? '<span class="fhir-tag">Immunization</span>' : ''}
              <span class="fhir-tag">Observation</span>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;align-items:center;gap:8px;">
            <span style="font-size:11px;color:var(--gray-400);">Synced to patient device:</span>
            <span class="badge ${r.synced_to_device ? 'badge-active' : 'badge-pending'}">${r.synced_to_device ? '‚úì Synced' : '‚è≥ QR pending'}</span>
          </div>
        </div>
      </div>
    `).join('')}
  `;
}

function toggleRecord(i) {
  document.getElementById('rec-card-' + i).classList.toggle('expanded');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW ENCOUNTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveEncounter() {
  const mnid = document.getElementById('enc-mnid').value.trim().toUpperCase();
  const dob = document.getElementById('enc-dob').value;
  const alertEl = document.getElementById('encounter-alert');

  if (!mnid || !dob) {
    alertEl.className = 'alert alert-danger'; alertEl.classList.remove('hidden');
    alertEl.textContent = '‚ö†Ô∏è Patient MNID and date of birth are required.';
    return;
  }

  const patients = DB.get('patients') || [];
  const p = patients.find(x => x.mnid === mnid);
  if (!p) {
    alertEl.className = 'alert alert-danger'; alertEl.classList.remove('hidden');
    alertEl.textContent = '‚ö†Ô∏è MNID not found in directory. Register the patient first.';
    return;
  }
  if (p.dob !== dob) {
    alertEl.className = 'alert alert-danger'; alertEl.classList.remove('hidden');
    alertEl.textContent = '‚ö†Ô∏è Date of birth verification failed. Does not match MNID record.';
    return;
  }

  const record = {
    id: 'REC-' + Date.now(),
    patient_mnid: mnid,
    record_type: document.getElementById('enc-type').value,
    facility_id: currentDoctor.facility_id,
    facility_name: currentDoctor.facility_name,
    doctor_id: currentDoctor.id,
    doctor_name: currentDoctor.name,
    created_at: document.getElementById('enc-date').value + 'T' + new Date().toTimeString().slice(0,5) + ':00Z',
    diagnosis: document.getElementById('enc-diagnosis').value || 'Unspecified',
    medications: document.getElementById('enc-medications').value || '',
    allergies: document.getElementById('enc-allergies').value || '',
    notes: document.getElementById('enc-notes').value || '',
    vitals: {
      bp: document.getElementById('enc-bp').value || '',
      temp: document.getElementById('enc-temp').value || '',
      weight: document.getElementById('enc-weight').value || ''
    },
    followup: document.getElementById('enc-followup').value,
    synced_to_device: false
  };
  // Clean empty vitals
  Object.keys(record.vitals).forEach(k => { if (!record.vitals[k]) delete record.vitals[k]; });

  DB.push('records', record);
  addAuditLog('RECORD_CREATED', mnid, [record.record_type], 'SUCCESS');
  toast('üíæ Record saved to facility database', 'success');

  // Generate QR
  generateQR(record, p.name);
  alertEl.classList.add('hidden');
}

function generateQR(record, patientName) {
  const payload = {
    version: '1.0',
    issuer_facility_id: record.facility_id,
    patient_mnid_hash: hashMnid(record.patient_mnid),
    record_type: record.record_type,
    fhir_bundle_encrypted: btoa(JSON.stringify({
      resourceType: 'Bundle',
      type: 'collection',
      entry: [{ resource: { resourceType: 'Encounter', status: 'finished', subject: { reference: record.patient_mnid }, diagnosis: record.diagnosis, note: record.notes } }]
    })).slice(0, 40) + '...[AES-256-GCM encrypted]',
    encryption_key_wrapped: 'RSA-OAEP:' + btoa(record.id).slice(0,20) + '...',
    issued_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
    signature: 'RSA-SHA256:' + btoa(record.id + record.facility_id).slice(0,32) + '...',
    record_id: record.id
  };

  const qrString = JSON.stringify(payload);
  DB.push('qr_pending', { ...payload, patient_name: patientName, full_record_id: record.id, full_patient_mnid: record.patient_mnid });

  const container = document.getElementById('qr-canvas-container');
  container.innerHTML = '';
  new QRCode(container, {
    text: qrString,
    width: 200, height: 200,
    colorDark: '#1F4E79', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });

  document.getElementById('qr-payload-preview').textContent = JSON.stringify(payload, null, 2);
  document.getElementById('qr-modal-overlay').classList.remove('hidden');
}

function closeQR() {
  document.getElementById('qr-modal-overlay').classList.add('hidden');
  clearEncounterForm();
  toast('‚úÖ QR code issued. Patient can scan in their Chipatala Connect app.', 'success');
}

function clearEncounterForm() {
  ['enc-mnid','enc-dob','enc-diagnosis','enc-medications','enc-allergies','enc-notes','enc-bp','enc-temp','enc-weight'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('enc-date').value = new Date().toISOString().slice(0, 10);
  document.getElementById('encounter-alert').classList.add('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSENT REQUESTS VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderConsentRequests() {
  const reqs = (DB.get('consent_requests') || []).filter(r => r.doctor_id === currentDoctor.id);
  const tbody = document.getElementById('consent-tbody');
  if (!reqs.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--gray-400);">No consent requests yet</td></tr>`;
    return;
  }
  tbody.innerHTML = reqs.slice().reverse().map(r => `
    <tr>
      <td><code style="font-size:12px;color:var(--navy);">${r.patient_mnid}</code><br><small style="color:var(--gray-400);">${r.patient_name||''}</small></td>
      <td>${r.scope.map(s => `<span class="badge badge-info" style="margin-right:2px;">${s}</span>`).join('')}</td>
      <td><span class="badge badge-${r.status.toLowerCase()}">${r.status}</span></td>
      <td style="font-size:12px;color:var(--gray-400);">${new Date(r.created_at).toLocaleString()}</td>
      <td style="font-size:12px;color:var(--gray-400);">${r.expires_at ? new Date(r.expires_at).toLocaleTimeString() : '‚Äî'}</td>
      <td>
        ${r.status === 'PENDING' ? `<button class="btn btn-success" style="padding:5px 10px;font-size:11px;" onclick="activateSession('${r.id}')">‚úì Simulate Approve</button>` : '‚Äî'}
        ${r.status === 'ACTIVE' ? `<button class="btn btn-primary" style="padding:5px 10px;font-size:11px;" onclick="navigate('active-session')">Open Session</button>` : ''}
      </td>
    </tr>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAuditLog() {
  const logs = (DB.get('audit_log') || []).slice().reverse();
  const el = document.getElementById('audit-log-content');
  if (!logs.length) { el.innerHTML = '<div class="empty-state"><p>No audit events recorded</p></div>'; return; }

  const eventColors = {
    RECORD_CREATED: { bg: 'var(--lightblue)', icon: 'üìã' },
    CONSENT_GRANTED: { bg: 'var(--green-light)', icon: '‚úÖ' },
    CONSENT_REQUESTED: { bg: 'var(--amber-light)', icon: 'üì§' },
    CONSENT_REVOKED: { bg: 'var(--red-light)', icon: 'üö´' },
    CROSS_FACILITY_ACCESS: { bg: '#EDE9FE', icon: 'üîÅ' },
    SESSION_EXPIRED: { bg: 'var(--gray-100)', icon: '‚è±' },
    ACCESS_DENIED: { bg: 'var(--red-light)', icon: '‚õî' },
  };

  el.innerHTML = logs.map(l => {
    const ev = eventColors[l.event_type] || { bg: 'var(--gray-100)', icon: 'üìù' };
    return `
      <div class="audit-row">
        <div class="audit-event-icon" style="background:${ev.bg};">${ev.icon}</div>
        <div style="flex:1;">
          <div style="font-size:12px;font-weight:700;color:var(--gray-800);">${l.event_type.replace(/_/g, ' ')}</div>
          <div style="font-size:11px;color:var(--gray-400);margin-top:2px;">
            Patient Hash: <code>${l.patient_mnid_hash}</code> &nbsp;¬∑&nbsp;
            Facility: ${l.requesting_facility} &nbsp;¬∑&nbsp;
            Clinician: ${l.requesting_clinician}
            ${l.source_facility ? ` &nbsp;¬∑&nbsp; Source: ${l.source_facility}` : ''}
          </div>
          <div style="font-size:11px;color:var(--gray-400);margin-top:2px;">Scope: ${(l.scope||[]).join(', ')}</div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <span class="badge badge-${l.outcome==='SUCCESS'?'active':l.outcome==='PENDING'?'pending':'revoked'}">${l.outcome}</span>
          <div style="font-size:10px;color:var(--gray-400);margin-top:4px;">${new Date(l.timestamp).toLocaleString()}</div>
        </div>
      </div>
    `;
  }).join('');
}

function addAuditLog(eventType, mnid, scope, outcome) {
  DB.push('audit_log', {
    event_id: uuid(),
    event_type: eventType,
    timestamp: new Date().toISOString(),
    patient_mnid_hash: hashMnid(mnid),
    requesting_facility: currentDoctor.facility_id,
    requesting_clinician: currentDoctor.id,
    scope,
    outcome
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPOINTMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAppointments() {
  const appts = DB.get('appointments') || [];
  const today = new Date().toISOString().slice(0, 10);
  const todayAppts = appts.filter(a => a.date === today && a.doctor_id === currentDoctor.id);

  const el = document.getElementById('today-appointments');
  if (!todayAppts.length) {
    el.innerHTML = `<div class="empty-state"><div class="icon">üìÖ</div><p>No appointments scheduled for today</p></div>`;
  } else {
    el.innerHTML = todayAppts.map(a => `
      <div class="appt-slot booked">
        <span style="font-size:20px;">üë§</span>
        <div>
          <div style="font-size:13px;font-weight:700;">${a.patient_mnid}</div>
          <div style="font-size:11px;color:var(--green);">${a.time} ¬∑ ${a.type}</div>
        </div>
      </div>
    `).join('');
  }
}

function bookAppointment() {
  const mnid = document.getElementById('appt-mnid').value.trim().toUpperCase();
  const date = document.getElementById('appt-date').value;
  if (!mnid || !date) return toast('Enter MNID and date', 'warning');

  const appt = {
    id: uuid(), patient_mnid: mnid, doctor_id: currentDoctor.id,
    facility_id: currentDoctor.facility_id, date, time: document.getElementById('appt-time').value,
    type: document.getElementById('appt-type').value, booked_at: new Date().toISOString()
  };
  DB.push('appointments', appt);
  toast(`üìÖ Appointment booked for ${mnid} on ${date}`, 'success');
  renderAppointments();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BADGES & UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBadges() {
  const reqs = DB.get('consent_requests') || [];
  const pending = reqs.filter(r => r.doctor_id === currentDoctor?.id && r.status === 'PENDING').length;
  const badge = document.getElementById('consent-badge');
  if (pending > 0) { badge.textContent = pending; badge.classList.remove('hidden'); }
  else badge.classList.add('hidden');

  const sessionBadge = document.getElementById('session-badge');
  if (activeSession) { sessionBadge.classList.remove('hidden'); }
  else sessionBadge.classList.add('hidden');
}

function toast(msg, type = 'default') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

// Init
document.getElementById('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
</script>
</body>
</html>
