<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chipatala Connect â€“ Patient App</title>
<style>
  :root {
    --navy: #1F4E79; --blue: #2E75B6; --sky: #BDD7EE; --lightblue: #D5E8F0;
    --green: #107C10; --green-light: #DFF0D8; --red: #C00000; --red-light: #FDECEA;
    --amber: #C7760A; --amber-light: #FFF3CD;
    --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0;
    --gray-400: #94A3B8; --gray-600: #475569; --gray-800: #1E293B;
    --white: #FFFFFF;
    --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --radius: 12px; --shadow: 0 2px 12px rgba(0,0,0,.08);
    --bottom-bar: 70px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { font-family: var(--font); background: var(--gray-50); color: var(--gray-800); max-width: 430px; margin: 0 auto; min-height: 100vh; position: relative; }
  .hidden { display: none !important; }
  .screen { min-height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ SPLASH / REGISTER â”€â”€ */
  .splash-bg {
    background: linear-gradient(160deg, var(--navy) 0%, var(--blue) 60%, #5BA3D9 100%);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 32px 24px; color: white; text-align: center;
  }
  .splash-logo { font-size: 64px; margin-bottom: 16px; }
  .splash-title { font-size: 28px; font-weight: 800; margin-bottom: 6px; }
  .splash-sub { font-size: 14px; opacity: .8; margin-bottom: 40px; }
  .pin-dots { display: flex; gap: 16px; justify-content: center; margin: 24px 0; }
  .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(255,255,255,.6); background: transparent; transition: background .15s; }
  .pin-dot.filled { background: white; border-color: white; }
  .pin-pad { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; max-width: 240px; margin: 0 auto; }
  .pin-key {
    background: rgba(255,255,255,.12); border: none; border-radius: 50%; width: 68px; height: 68px;
    font-size: 22px; font-weight: 700; color: white; cursor: pointer; transition: background .15s;
    display: flex; align-items: center; justify-content: center; font-family: var(--font);
  }
  .pin-key:hover { background: rgba(255,255,255,.22); }
  .pin-key:active { background: rgba(255,255,255,.35); transform: scale(.95); }
  .pin-key.del { font-size: 18px; }
  .pin-key.empty { visibility: hidden; }

  /* â”€â”€ FORM ELEMENTS â”€â”€ */
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; color: rgba(255,255,255,.7); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .05em; }
  .form-group.light label { color: var(--gray-600); }
  .form-group input, .form-group select {
    width: 100%; padding: 13px 16px; border-radius: var(--radius); font-size: 15px;
    border: 1.5px solid rgba(255,255,255,.3); background: rgba(255,255,255,.15);
    color: white; font-family: var(--font); transition: border-color .2s;
  }
  .form-group input::placeholder { color: rgba(255,255,255,.5); }
  .form-group input:focus { outline: none; border-color: white; background: rgba(255,255,255,.25); }
  .form-group.light input, .form-group.light select {
    background: white; color: var(--gray-800); border-color: var(--gray-200);
  }
  .form-group.light input::placeholder { color: var(--gray-400); }
  .form-group.light input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(46,117,182,.1); }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 24px; border-radius: var(--radius); font-size: 15px; font-weight: 700;
    cursor: pointer; border: none; transition: all .2s; font-family: var(--font); width: 100%;
  }
  .btn-white { background: white; color: var(--navy); }
  .btn-white:hover { background: var(--lightblue); }
  .btn-primary { background: var(--blue); color: white; }
  .btn-primary:hover { background: var(--navy); }
  .btn-success { background: var(--green); color: white; }
  .btn-danger { background: var(--red); color: white; }
  .btn-ghost { background: transparent; color: var(--blue); border: 1.5px solid var(--blue); }
  .btn-outline-white { background: transparent; border: 1.5px solid rgba(255,255,255,.5); color: white; }
  .btn-outline-white:hover { background: rgba(255,255,255,.1); }
  .btn-sm { padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }

  /* â”€â”€ TOP HEADER â”€â”€ */
  .app-header {
    background: white; padding: 16px 20px; display: flex; align-items: center; gap: 12px;
    border-bottom: 1px solid var(--gray-200); position: sticky; top: 0; z-index: 100;
    box-shadow: 0 1px 4px rgba(0,0,0,.06);
  }
  .app-header .back-btn { font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 8px; }
  .app-header .back-btn:hover { background: var(--gray-100); }
  .app-header h2 { font-size: 17px; font-weight: 700; color: var(--navy); flex: 1; }
  .app-header .header-action { font-size: 20px; cursor: pointer; padding: 4px 8px; }

  /* â”€â”€ BOTTOM NAV â”€â”€ */
  .bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 430px; background: white; border-top: 1px solid var(--gray-200);
    display: flex; z-index: 200; box-shadow: 0 -2px 12px rgba(0,0,0,.06);
  }
  .nav-tab {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 10px 4px; cursor: pointer; transition: color .15s; color: var(--gray-400);
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; gap: 3px;
    position: relative;
  }
  .nav-tab .tab-icon { font-size: 22px; line-height: 1; }
  .nav-tab.active { color: var(--blue); }
  .nav-tab .tab-badge {
    position: absolute; top: 6px; right: calc(50% - 16px);
    background: var(--red); color: white; font-size: 9px; font-weight: 700;
    border-radius: 8px; padding: 1px 5px; min-width: 16px; text-align: center;
  }

  /* â”€â”€ CONTENT AREA â”€â”€ */
  .content { flex: 1; overflow-y: auto; padding-bottom: calc(var(--bottom-bar) + 16px); }
  .content-padded { padding: 20px; }

  /* â”€â”€ CARDS â”€â”€ */
  .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--gray-200); margin-bottom: 16px; overflow: hidden; }
  .card-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-100); display: flex; align-items: center; justify-content: space-between; }
  .card-header h3 { font-size: 14px; font-weight: 700; color: var(--navy); }
  .card-body { padding: 16px 20px; }

  /* â”€â”€ HOME HERO â”€â”€ */
  .home-hero {
    background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%);
    color: white; padding: 24px 20px; position: relative; overflow: hidden;
  }
  .home-hero::after { content: ''; position: absolute; right: -20px; top: -20px; width: 120px; height: 120px; background: rgba(255,255,255,.06); border-radius: 50%; }
  .home-hero .greeting { font-size: 13px; opacity: .8; margin-bottom: 4px; }
  .home-hero .name { font-size: 22px; font-weight: 800; }
  .home-hero .mnid-chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,.15); border-radius: 20px; padding: 5px 12px; font-size: 12px; margin-top: 10px; font-family: monospace; }

  /* â”€â”€ HEALTH STATUS PILLS â”€â”€ */
  .health-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px; }
  .health-pill { background: rgba(255,255,255,.15); border-radius: 20px; padding: 5px 12px; font-size: 11px; font-weight: 600; }

  /* â”€â”€ RECORD LIST ITEM â”€â”€ */
  .record-item { display: flex; align-items: center; gap: 14px; padding: 14px 20px; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background .15s; }
  .record-item:last-child { border-bottom: none; }
  .record-item:hover { background: var(--gray-50); }
  .record-item:active { background: var(--lightblue); }
  .record-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
  .record-icon.encounter { background: var(--lightblue); }
  .record-icon.lab { background: #FFF3CD; }
  .record-icon.prescription { background: var(--green-light); }
  .record-icon.vaccination { background: #EDE9FE; }
  .record-icon.referral { background: var(--amber-light); }
  .record-meta { flex: 1; min-width: 0; }
  .record-meta .title { font-size: 14px; font-weight: 600; color: var(--gray-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .record-meta .sub { font-size: 12px; color: var(--gray-400); margin-top: 2px; }
  .record-chevron { color: var(--gray-400); font-size: 14px; }

  /* â”€â”€ CONSENT CARD â”€â”€ */
  .consent-alert {
    background: var(--amber-light); border: 1.5px solid var(--amber); border-radius: var(--radius);
    padding: 16px; margin-bottom: 16px;
  }
  .consent-alert .title { font-size: 14px; font-weight: 700; color: var(--amber); margin-bottom: 6px; }
  .consent-alert .body { font-size: 13px; color: var(--gray-800); margin-bottom: 12px; }
  .consent-alert .scope-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .scope-tag { background: white; border: 1px solid var(--amber); border-radius: 20px; padding: 3px 10px; font-size: 11px; font-weight: 600; color: var(--amber); }
  .consent-actions { display: flex; gap: 8px; }
  .consent-actions .btn { flex: 1; padding: 11px 16px; font-size: 13px; border-radius: 10px; }

  /* â”€â”€ SESSION CARD â”€â”€ */
  .session-card { background: var(--green-light); border: 1.5px solid var(--green); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
  .session-card .title { font-size: 14px; font-weight: 700; color: var(--green); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
  .session-timer { font-size: 22px; font-weight: 800; color: var(--green); font-variant-numeric: tabular-nums; }

  /* â”€â”€ QR SCANNER â”€â”€ */
  .qr-scanner-area {
    background: var(--gray-800); border-radius: var(--radius); padding: 32px 24px; text-align: center;
    margin-bottom: 20px; position: relative; overflow: hidden;
  }
  .qr-scanner-area .scanner-frame {
    width: 200px; height: 200px; border: 3px solid var(--blue); border-radius: 12px;
    margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;
    position: relative; background: rgba(255,255,255,.05);
  }
  .scanner-frame::before, .scanner-frame::after {
    content: ''; position: absolute; width: 24px; height: 24px; border-color: var(--sky);
    border-style: solid;
  }
  .scanner-frame::before { top: -3px; left: -3px; border-width: 4px 0 0 4px; border-radius: 4px 0 0 0; }
  .scanner-frame::after { bottom: -3px; right: -3px; border-width: 0 4px 4px 0; border-radius: 0 0 4px 0; }
  .scan-line { position: absolute; width: 80%; height: 2px; background: var(--blue); left: 10%; animation: scanMove 2s linear infinite; }
  @keyframes scanMove { 0% { top: 10%; } 100% { top: 90%; } }

  /* â”€â”€ RECORD DETAIL â”€â”€ */
  .detail-section { padding: 16px 20px; border-bottom: 1px solid var(--gray-100); }
  .detail-section:last-child { border-bottom: none; }
  .detail-label { font-size: 11px; font-weight: 700; color: var(--gray-400); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 6px; }
  .detail-value { font-size: 14px; color: var(--gray-800); }
  .detail-value.allergy { color: var(--red); font-weight: 600; }
  .fhir-tag { display: inline-block; background: var(--lightblue); color: var(--navy); font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 4px; margin-right: 4px; margin-bottom: 4px; font-family: monospace; }
  .enc-badge { display: inline-flex; align-items: center; gap: 6px; background: #EDE9FE; color: #6D28D9; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }

  /* â”€â”€ BADGE â”€â”€ */
  .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .badge-pending { background: var(--amber-light); color: var(--amber); }
  .badge-active { background: var(--green-light); color: var(--green); }
  .badge-expired { background: var(--gray-100); color: var(--gray-600); }
  .badge-revoked { background: var(--red-light); color: var(--red); }
  .badge-info { background: var(--lightblue); color: var(--navy); }

  /* â”€â”€ PROFILE â”€â”€ */
  .profile-hero { background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%); color: white; padding: 32px 20px 24px; text-align: center; }
  .profile-avatar { width: 72px; height: 72px; background: rgba(255,255,255,.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; margin: 0 auto 12px; }
  .profile-name { font-size: 20px; font-weight: 800; }
  .profile-mnid { font-size: 12px; opacity: .8; font-family: monospace; margin-top: 4px; }

  /* â”€â”€ ACCESS LOG â”€â”€ */
  .access-row { display: flex; align-items: flex-start; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--gray-100); }
  .access-row:last-child { border-bottom: none; }
  .access-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }

  /* â”€â”€ USSD SIMULATOR â”€â”€ */
  .ussd-screen {
    background: #1a1a1a; color: #00FF41; font-family: 'Courier New', monospace; font-size: 13px;
    padding: 24px 20px; border-radius: var(--radius); min-height: 240px; margin-bottom: 16px;
    border: 2px solid #333; position: relative;
  }
  .ussd-screen::before { content: '*860#'; position: absolute; top: 8px; right: 12px; font-size: 10px; opacity: .4; }
  .ussd-line { margin-bottom: 6px; }
  .ussd-input-area { display: flex; gap: 8px; margin-top: 16px; }
  .ussd-input { flex: 1; padding: 10px 14px; background: #2a2a2a; border: 1px solid #444; color: #00FF41; font-family: 'Courier New', monospace; font-size: 14px; border-radius: 8px; }
  .ussd-input:focus { outline: none; border-color: #00FF41; }
  .ussd-send-btn { background: #00AA2E; color: white; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: var(--font); }

  /* â”€â”€ ALERTS â”€â”€ */
  .alert { padding: 12px 16px; border-radius: 10px; margin-bottom: 12px; font-size: 13px; display: flex; align-items: flex-start; gap: 8px; }
  .alert-success { background: var(--green-light); color: var(--green); border: 1px solid #c3e6cb; }
  .alert-danger { background: var(--red-light); color: var(--red); border: 1px solid #f5c6cb; }
  .alert-info { background: var(--lightblue); color: var(--navy); border: 1px solid var(--sky); }
  .alert-warning { background: var(--amber-light); color: var(--amber); }

  /* â”€â”€ TOAST â”€â”€ */
  .toast-container { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; width: calc(100% - 32px); max-width: 400px; pointer-events: none; }
  .toast { background: var(--gray-800); color: white; padding: 12px 16px; border-radius: 10px; font-size: 13px; margin-bottom: 8px; box-shadow: 0 4px 16px rgba(0,0,0,.3); animation: dropIn .3s ease; }
  .toast.success { background: var(--green); }
  .toast.error { background: var(--red); }
  .toast.warning { background: var(--amber); }
  @keyframes dropIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: var(--gray-200); border-radius: 2px; }

  /* Empty state */
  .empty-state { text-align: center; padding: 40px 24px; color: var(--gray-400); }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 13px; }

  /* Inline info row */
  .info-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--gray-100); font-size: 13px; }
  .info-row:last-child { border-bottom: none; }
  .info-row .label { color: var(--gray-600); }
  .info-row .value { font-weight: 600; text-align: right; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPLASH / AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-auth" class="splash-bg">
  <!-- LOGIN -->
  <div id="auth-login">
    <div class="splash-logo">ğŸ’Š</div>
    <div class="splash-title">Chipatala Connect</div>
    <div class="splash-sub">Your Digital Health Passport</div>

    <div id="pin-instruction" style="font-size:14px;opacity:.8;margin-bottom:8px;">Enter your 4-digit PIN</div>
    <div class="pin-dots" id="pin-dots">
      <div class="pin-dot" id="dot-0"></div>
      <div class="pin-dot" id="dot-1"></div>
      <div class="pin-dot" id="dot-2"></div>
      <div class="pin-dot" id="dot-3"></div>
    </div>
    <div id="pin-error" style="color:#FF8080;font-size:13px;margin-bottom:8px;" class="hidden">Incorrect PIN. Try again.</div>

    <div class="pin-pad">
      <button class="pin-key" onclick="pinInput('1')">1</button>
      <button class="pin-key" onclick="pinInput('2')">2</button>
      <button class="pin-key" onclick="pinInput('3')">3</button>
      <button class="pin-key" onclick="pinInput('4')">4</button>
      <button class="pin-key" onclick="pinInput('5')">5</button>
      <button class="pin-key" onclick="pinInput('6')">6</button>
      <button class="pin-key" onclick="pinInput('7')">7</button>
      <button class="pin-key" onclick="pinInput('8')">8</button>
      <button class="pin-key" onclick="pinInput('9')">9</button>
      <button class="pin-key empty"></button>
      <button class="pin-key" onclick="pinInput('0')">0</button>
      <button class="pin-key del" onclick="pinDel()">âŒ«</button>
    </div>
    <button class="btn btn-outline-white" style="margin-top:24px;" onclick="showRegister()">New Patient? Register â†’</button>
    <p style="font-size:11px;opacity:.5;margin-top:12px;">Demo PIN: 1234 &nbsp;Â·&nbsp; Accounts: MW-12345678, MW-87654321</p>
  </div>

  <!-- REGISTER -->
  <div id="auth-register" class="hidden" style="width:100%;max-width:380px;">
    <div class="splash-logo" style="margin-bottom:8px;">ğŸ“</div>
    <div class="splash-title" style="font-size:22px;margin-bottom:20px;">Create Your Health Passport</div>

    <div class="form-group"><label>Full Name *</label><input id="reg-name" type="text" placeholder="e.g. Grace Phiri"></div>
    <div class="form-group"><label>Malawi National ID (MNID) *</label><input id="reg-mnid" type="text" placeholder="MW-XXXXXXXX" style="text-transform:uppercase;"></div>
    <div class="form-group"><label>Date of Birth *</label><input id="reg-dob" type="date"></div>
    <div class="form-group"><label>Phone Number</label><input id="reg-phone" type="tel" placeholder="+265 9X XXX XXXX"></div>
    <div class="form-group"><label>Set 4-Digit PIN *</label><input id="reg-pin" type="password" maxlength="4" placeholder="Choose a PIN" inputmode="numeric"></div>
    <div id="reg-error" class="alert alert-danger hidden" style="background:rgba(255,0,0,.15);border-color:rgba(255,80,80,.4);color:#ff9999;"></div>
    <button class="btn btn-white" onclick="doRegister()" style="margin-bottom:12px;">Create Health Passport</button>
    <button class="btn btn-outline-white" onclick="showLogin()">â† Back to Login</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-app" class="hidden screen">

  <!-- â”€â”€ HOME â”€â”€ -->
  <div id="view-home" class="screen">
    <div class="content" id="home-content">
      <!-- hero and content inserted dynamically -->
    </div>
    <div class="bottom-nav" id="bottom-nav-home"></div>
  </div>

  <!-- â”€â”€ PASSPORT (Records) â”€â”€ -->
  <div id="view-passport" class="screen hidden">
    <div class="app-header">
      <h2>Health Passport</h2>
      <span class="header-action" onclick="navigate('home')">ğŸ </span>
    </div>
    <div class="content">
      <div id="passport-content"></div>
    </div>
    <div class="bottom-nav" id="bottom-nav-passport"></div>
  </div>

  <!-- â”€â”€ RECORD DETAIL â”€â”€ -->
  <div id="view-record-detail" class="screen hidden">
    <div class="app-header">
      <span class="back-btn" onclick="navigate('passport')">â†</span>
      <h2 id="detail-title">Record Detail</h2>
    </div>
    <div class="content" id="record-detail-content"></div>
  </div>

  <!-- â”€â”€ CONSENTS â”€â”€ -->
  <div id="view-consents" class="screen hidden">
    <div class="app-header">
      <h2>Consent Requests</h2>
      <span class="header-action" onclick="navigate('home')">ğŸ </span>
    </div>
    <div class="content">
      <div id="consents-content" class="content-padded"></div>
    </div>
    <div class="bottom-nav" id="bottom-nav-consents"></div>
  </div>

  <!-- â”€â”€ QR SCAN (Receive Record) â”€â”€ -->
  <div id="view-qr" class="screen hidden">
    <div class="app-header">
      <span class="back-btn" onclick="navigate('home')">â†</span>
      <h2>Receive Record</h2>
    </div>
    <div class="content content-padded">
      <div class="qr-scanner-area">
        <div class="scanner-frame">
          <div class="scan-line"></div>
          <span style="font-size:48px;opacity:.3;">ğŸ“·</span>
        </div>
        <p style="color:rgba(255,255,255,.7);font-size:13px;">Point camera at QR code from doctor</p>
      </div>

      <div class="card">
        <div class="card-header"><h3>ğŸ’¡ Enter Record Code Manually</h3></div>
        <div class="card-body">
          <p style="font-size:13px;color:var(--gray-600);margin-bottom:12px;">
            Ask your doctor for the record code if scanning doesn't work.
          </p>
          <div class="form-group light">
            <input id="qr-manual-input" type="text" placeholder="Paste record code or ID...">
          </div>
          <button class="btn btn-primary btn-sm" style="width:100%;" onclick="processManualQR()">Import Record</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>ğŸ“‹ Pending QR Records</h3></div>
        <div class="card-body" style="padding:0;" id="pending-qr-list">
          <!-- populated dynamically -->
        </div>
      </div>

      <div id="qr-result" class="hidden"></div>
    </div>
    <div class="bottom-nav" id="bottom-nav-qr"></div>
  </div>

  <!-- â”€â”€ PROFILE â”€â”€ -->
  <div id="view-profile" class="screen hidden">
    <div class="content">
      <div id="profile-content"></div>
    </div>
    <div class="bottom-nav" id="bottom-nav-profile"></div>
  </div>

  <!-- â”€â”€ ACCESS HISTORY â”€â”€ -->
  <div id="view-access-history" class="screen hidden">
    <div class="app-header">
      <span class="back-btn" onclick="navigate('profile')">â†</span>
      <h2>Access History</h2>
    </div>
    <div class="content content-padded" id="access-history-content"></div>
  </div>

  <!-- â”€â”€ USSD SIMULATOR â”€â”€ -->
  <div id="view-ussd" class="screen hidden">
    <div class="app-header">
      <span class="back-btn" onclick="navigate('profile')">â†</span>
      <h2>USSD Mode (*860#)</h2>
    </div>
    <div class="content content-padded">
      <div class="alert alert-info">ğŸ“± Simulates feature phone USSD interface for rural/offline access</div>
      <div class="ussd-screen" id="ussd-display"></div>
      <div class="ussd-input-area">
        <input type="text" class="ussd-input" id="ussd-input" placeholder="Enter option..." inputmode="numeric">
        <button class="ussd-send-btn" onclick="ussdSend()">Send</button>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="ussdReset()">Restart Session</button>
    </div>
  </div>

</div><!-- end screen-app -->

<div class="toast-container" id="toast-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
  get: k => { try { return JSON.parse(localStorage.getItem('cc_' + k) || 'null'); } catch { return null; } },
  set: (k, v) => localStorage.setItem('cc_' + k, JSON.stringify(v)),
  push: (k, item) => { const arr = DB.get(k) || []; arr.push(item); DB.set(k, arr); return item; }
};

let currentPatient = null;
let pinBuffer = '';
let currentView = 'home';
let patientActiveSession = null;
let sessionPollInterval = null;
let ussdState = { menu: 'main', data: {} };

function uuid() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pinInput(digit) {
  if (pinBuffer.length >= 4) return;
  pinBuffer += digit;
  updatePinDots();
  if (pinBuffer.length === 4) setTimeout(checkPin, 200);
}
function pinDel() {
  pinBuffer = pinBuffer.slice(0, -1);
  updatePinDots();
}
function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    document.getElementById('dot-' + i).classList.toggle('filled', i < pinBuffer.length);
  }
}
function checkPin() {
  const patients = DB.get('patients') || [];
  const p = patients.find(x => x.pin_hash === pinBuffer);
  if (!p) {
    pinBuffer = '';
    updatePinDots();
    document.getElementById('pin-error').classList.remove('hidden');
    document.getElementById('pin-instruction').textContent = 'Incorrect PIN â€” try again';
    setTimeout(() => { document.getElementById('pin-error').classList.add('hidden'); document.getElementById('pin-instruction').textContent = 'Enter your 4-digit PIN'; }, 2000);
    return;
  }
  currentPatient = p;
  launchApp();
}

function showRegister() {
  document.getElementById('auth-login').classList.add('hidden');
  document.getElementById('auth-register').classList.remove('hidden');
}
function showLogin() {
  document.getElementById('auth-register').classList.add('hidden');
  document.getElementById('auth-login').classList.remove('hidden');
  pinBuffer = ''; updatePinDots();
}

function doRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const mnid = document.getElementById('reg-mnid').value.trim().toUpperCase();
  const dob = document.getElementById('reg-dob').value;
  const phone = document.getElementById('reg-phone').value.trim();
  const pin = document.getElementById('reg-pin').value;
  const errEl = document.getElementById('reg-error');

  if (!name || !mnid || !dob || !pin) { errEl.textContent = 'All fields marked * are required.'; errEl.classList.remove('hidden'); return; }
  if (!/^MW-\d{8}$/.test(mnid)) { errEl.textContent = 'MNID must be in format MW-XXXXXXXX'; errEl.classList.remove('hidden'); return; }
  if (pin.length !== 4 || !/^\d{4}$/.test(pin)) { errEl.textContent = 'PIN must be 4 digits.'; errEl.classList.remove('hidden'); return; }

  const patients = DB.get('patients') || [];
  if (patients.find(p => p.mnid === mnid)) { errEl.textContent = 'MNID already registered. Please log in.'; errEl.classList.remove('hidden'); return; }

  const newPatient = { id: 'PT-' + Date.now(), mnid, name, dob, phone, pin_hash: pin, tier: 1, registered_at: new Date().toISOString().slice(0,10), facilities: [] };
  patients.push(newPatient);
  DB.set('patients', patients);
  currentPatient = newPatient;
  toast('âœ… Health passport created!', 'success');
  launchApp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP LAUNCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchApp() {
  document.getElementById('screen-auth').classList.add('hidden');
  document.getElementById('screen-app').classList.remove('hidden');
  navigate('home');
  buildBottomNavs();
  startConsentPolling();
}

function buildBottomNavs() {
  const navHtml = `
    <div class="nav-tab ${currentView==='home'?'active':''}" onclick="navigate('home')">
      <span class="tab-icon">ğŸ </span>Home
    </div>
    <div class="nav-tab ${currentView==='passport'?'active':''}" onclick="navigate('passport')">
      <span class="tab-icon">ğŸ“‹</span>Passport
    </div>
    <div class="nav-tab ${currentView==='qr'?'active':''}" onclick="navigate('qr')">
      <span class="tab-icon">ğŸ“·</span>Scan QR
    </div>
    <div class="nav-tab ${currentView==='consents'?'active':''}" onclick="navigate('consents')" id="nav-consents">
      <span class="tab-icon">ğŸ””</span>Consent
      <span class="tab-badge hidden" id="nav-consent-badge">0</span>
    </div>
    <div class="nav-tab ${currentView==='profile'?'active':''}" onclick="navigate('profile')">
      <span class="tab-icon">ğŸ‘¤</span>Profile
    </div>
  `;
  ['home','passport','qr','consents','profile'].forEach(id => {
    const el = document.getElementById('bottom-nav-' + id);
    if (el) el.innerHTML = navHtml;
  });
  updateConsentBadge();
}

function updateConsentBadge() {
  const reqs = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.status === 'PENDING');
  document.querySelectorAll('#nav-consent-badge').forEach(el => {
    el.textContent = reqs.length;
    el.classList.toggle('hidden', reqs.length === 0);
  });
  document.querySelectorAll('.nav-tab').forEach(tab => {
    const hasConsent = reqs.length > 0 && tab.textContent.includes('Consent');
    if (hasConsent) tab.style.color = 'var(--amber)';
  });
}

function startConsentPolling() {
  if (sessionPollInterval) clearInterval(sessionPollInterval);
  sessionPollInterval = setInterval(() => {
    updateConsentBadge();
    checkForNewConsents();
  }, 3000);
}

function checkForNewConsents() {
  const reqs = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.status === 'PENDING');
  if (reqs.length > 0 && currentView === 'home') renderHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(view) {
  document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById('view-' + view).classList.remove('hidden');
  currentView = view;
  buildBottomNavs();

  if (view === 'home') renderHome();
  if (view === 'passport') renderPassport();
  if (view === 'consents') renderConsents();
  if (view === 'qr') renderQR();
  if (view === 'profile') renderProfile();
  if (view === 'access-history') renderAccessHistory();
  if (view === 'ussd') initUSSD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome() {
  const p = currentPatient;
  const records = (DB.get('records') || []).filter(r => r.patient_mnid === p.mnid);
  const pendingConsents = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === p.mnid && r.status === 'PENDING');
  const activeConsents = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === p.mnid && r.status === 'ACTIVE' && new Date(r.expires_at) > new Date());
  const pendingQRs = (DB.get('qr_pending') || []).filter(q => q.full_patient_mnid === p.mnid);

  const greet = new Date().getHours() < 12 ? 'Good morning' : new Date().getHours() < 17 ? 'Good afternoon' : 'Good evening';
  const firstName = p.name.split(' ')[0];

  let html = `
    <div class="home-hero">
      <div class="greeting">${greet}</div>
      <div class="name">${firstName} ğŸ‘‹</div>
      <div class="mnid-chip">ğŸ†” ${p.mnid}</div>
      <div class="health-pills">
        <span class="health-pill">ğŸ“‹ ${records.length} Records</span>
        <span class="health-pill">ğŸ¥ ${p.facilities?.length || 0} Facilities</span>
        <span class="health-pill" style="background:${pendingConsents.length > 0 ? 'var(--amber)' : 'rgba(255,255,255,.15)'};">ğŸ”” ${pendingConsents.length} Pending</span>
      </div>
    </div>
    <div class="content-padded">
  `;

  // Consent alerts
  pendingConsents.forEach(req => {
    html += `
      <div class="consent-alert">
        <div class="title">ğŸ”” Consent Request</div>
        <div class="body">
          <strong>${req.doctor_name}</strong> at ${req.facility_name} is requesting access to your health records.
        </div>
        <div class="scope-tags">
          ${req.scope.map(s => `<span class="scope-tag">${s.replace(/_/g,' ')}</span>`).join('')}
        </div>
        <div class="consent-actions">
          <button class="btn btn-success" onclick="grantConsent('${req.id}')">âœ“ Grant Access</button>
          <button class="btn btn-danger" onclick="denyConsent('${req.id}')">âœ• Deny</button>
        </div>
      </div>
    `;
  });

  // Active sessions
  activeConsents.forEach(req => {
    const secsLeft = Math.max(0, Math.floor((new Date(req.expires_at) - new Date()) / 1000));
    const h = Math.floor(secsLeft / 3600).toString().padStart(2,'0');
    const m = Math.floor((secsLeft % 3600) / 60).toString().padStart(2,'0');
    html += `
      <div class="session-card">
        <div class="title">ğŸ”“ Active Session</div>
        <div style="font-size:13px;color:var(--green);margin-bottom:6px;"><strong>${req.doctor_name}</strong> Â· ${req.facility_name}</div>
        <div style="font-size:12px;color:var(--gray-600);margin-bottom:10px;">Scope: ${req.scope.join(', ')} Â· Expires in: <strong>${h}:${m}</strong></div>
        <button class="btn btn-danger btn-sm" style="width:auto;" onclick="revokeConsent('${req.id}')">ğŸš« Revoke Access</button>
      </div>
    `;
  });

  // Pending QR notification
  if (pendingQRs.length > 0) {
    html += `
      <div class="alert alert-info">
        ğŸ“± <strong>${pendingQRs.length} record(s)</strong> are waiting for you to scan the QR code.
        <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="navigate('qr')">Scan Now â†’</button>
      </div>
    `;
  }

  // Recent records
  const recent = records.slice(-3).reverse();
  if (recent.length) {
    html += `
      <div class="card">
        <div class="card-header"><h3>Recent Records</h3><span onclick="navigate('passport')" style="font-size:13px;color:var(--blue);cursor:pointer;">See all â†’</span></div>
        <div style="padding:0;">
          ${recent.map(r => recordListItem(r)).join('')}
        </div>
      </div>
    `;
  }

  // Quick actions
  html += `
    <div class="card">
      <div class="card-header"><h3>Quick Actions</h3></div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:10px;">
        <button class="btn btn-primary" onclick="navigate('qr')">ğŸ“· &nbsp;Receive New Record (QR)</button>
        <button class="btn btn-ghost" onclick="navigate('consents')">ğŸ”” &nbsp;View Consent Requests</button>
        <button class="btn btn-ghost" onclick="navigate('passport')">ğŸ“‹ &nbsp;View Health Passport</button>
      </div>
    </div>
  </div>`;

  document.getElementById('home-content').innerHTML = html;
}

function recordListItem(r) {
  const icons = { encounter_summary: 'ğŸ©º', lab_result: 'ğŸ§ª', prescription: 'ğŸ’Š', vaccination: 'ğŸ’‰', observation: 'ğŸ“Š', referral: 'â†—ï¸' };
  const iconClass = { encounter_summary: 'encounter', lab_result: 'lab', prescription: 'prescription', vaccination: 'vaccination', referral: 'referral' };
  return `
    <div class="record-item" onclick="openRecord('${r.id}')">
      <div class="record-icon ${iconClass[r.record_type]||'encounter'}">${icons[r.record_type]||'ğŸ“‹'}</div>
      <div class="record-meta">
        <div class="title">${r.diagnosis}</div>
        <div class="sub">${new Date(r.created_at).toLocaleDateString()} Â· ${r.facility_name}</div>
      </div>
      <span class="record-chevron">â€º</span>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPassport() {
  const records = (DB.get('records') || []).filter(r => r.patient_mnid === currentPatient.mnid);
  const el = document.getElementById('passport-content');

  if (!records.length) {
    el.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“­</div><p>No records yet.<br>Ask your doctor to issue you a QR record.</p></div>`;
    return;
  }

  const byType = {};
  records.forEach(r => { if (!byType[r.record_type]) byType[r.record_type] = []; byType[r.record_type].push(r); });

  const typeLabels = { encounter_summary: 'ğŸ©º Encounters', lab_result: 'ğŸ§ª Lab Results', prescription: 'ğŸ’Š Prescriptions', vaccination: 'ğŸ’‰ Vaccinations', observation: 'ğŸ“Š Observations', referral: 'â†—ï¸ Referrals' };

  let html = `
    <div style="padding:12px 16px 0;">
      <div class="enc-badge">ğŸ”’ AES-256 Encrypted &nbsp;Â·&nbsp; ${records.length} records</div>
    </div>
  `;

  Object.keys(byType).forEach(type => {
    html += `
      <div class="card" style="margin:12px 16px 0;">
        <div class="card-header"><h3>${typeLabels[type]||type} (${byType[type].length})</h3></div>
        <div style="padding:0;">
          ${byType[type].slice().reverse().map(r => recordListItem(r)).join('')}
        </div>
      </div>
    `;
  });
  html += '<div style="height:16px;"></div>';
  el.innerHTML = html;
}

function openRecord(id) {
  const records = DB.get('records') || [];
  const r = records.find(x => x.id === id);
  if (!r) return;

  document.getElementById('view-passport').classList.add('hidden');
  document.getElementById('view-record-detail').classList.remove('hidden');

  const icons = { encounter_summary: 'ğŸ©º', lab_result: 'ğŸ§ª', prescription: 'ğŸ’Š', vaccination: 'ğŸ’‰', observation: 'ğŸ“Š', referral: 'â†—ï¸' };
  document.getElementById('detail-title').textContent = icons[r.record_type] + ' ' + r.record_type.replace(/_/g,' ');

  document.getElementById('record-detail-content').innerHTML = `
    <div class="detail-section">
      <div style="background:linear-gradient(135deg,var(--navy),var(--blue));color:white;padding:20px;border-radius:var(--radius) var(--radius) 0 0;margin:-16px -20px 16px;">
        <div style="font-size:11px;opacity:.7;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">${r.record_type.replace(/_/g,' ')}</div>
        <div style="font-size:16px;font-weight:700;">${r.diagnosis}</div>
        <div style="font-size:12px;opacity:.7;margin-top:4px;">${new Date(r.created_at).toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}</div>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Issued By</div>
      <div class="detail-value">${r.doctor_name}</div>
      <div style="font-size:12px;color:var(--gray-400);margin-top:2px;">${r.facility_name}</div>
    </div>

    ${r.medications ? `<div class="detail-section">
      <div class="detail-label">ğŸ’Š Medications</div>
      <div class="detail-value">${r.medications}</div>
    </div>` : ''}

    ${r.allergies ? `<div class="detail-section">
      <div class="detail-label">âš ï¸ Allergies</div>
      <div class="detail-value allergy">${r.allergies}</div>
    </div>` : ''}

    ${Object.keys(r.vitals||{}).filter(k=>r.vitals[k]).length > 0 ? `<div class="detail-section">
      <div class="detail-label">ğŸ“Š Vital Signs</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;">
        ${Object.entries(r.vitals).filter(([k,v])=>v).map(([k,v]) => `
          <div style="background:var(--gray-50);border-radius:8px;padding:10px;text-align:center;">
            <div style="font-size:11px;color:var(--gray-400);font-weight:600;text-transform:uppercase;">${k==='bp'?'Blood Pressure':k==='temp'?'Temperature':k==='weight'?'Weight':k}</div>
            <div style="font-size:16px;font-weight:700;color:var(--navy);margin-top:2px;">${v}</div>
          </div>
        `).join('')}
      </div>
    </div>` : ''}

    ${r.notes ? `<div class="detail-section">
      <div class="detail-label">ğŸ“ Clinical Notes</div>
      <div class="detail-value" style="line-height:1.6;">${r.notes}</div>
    </div>` : ''}

    ${r.followup && r.followup !== 'none' ? `<div class="detail-section">
      <div class="detail-label">ğŸ“… Follow-up</div>
      <div class="detail-value" style="color:var(--amber);">Required â€” ${r.followup.replace('hivart','HIV/ART protocol').replace('antenatal','Antenatal schedule')}</div>
    </div>` : ''}

    <div class="detail-section">
      <div class="detail-label">FHIR Resources</div>
      <div style="margin-top:4px;">
        <span class="fhir-tag">Bundle</span><span class="fhir-tag">Encounter</span>
        ${r.medications ? '<span class="fhir-tag">MedicationRequest</span>' : ''}
        ${r.allergies ? '<span class="fhir-tag">AllergyIntolerance</span>' : ''}
        ${r.record_type === 'lab_result' ? '<span class="fhir-tag">DiagnosticReport</span>' : ''}
        ${r.record_type === 'vaccination' ? '<span class="fhir-tag">Immunization</span>' : ''}
        <span class="fhir-tag">Observation</span>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Storage</div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
        <span class="enc-badge">ğŸ”’ AES-256-GCM Encrypted</span>
        <span class="badge badge-${r.synced_to_device ? 'active' : 'pending'}">${r.synced_to_device ? 'âœ“ On device' : 'â³ Pending sync'}</span>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSENT MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderConsents() {
  const all = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient.mnid);
  const el = document.getElementById('consents-content');

  if (!all.length) {
    el.innerHTML = `<div class="empty-state"><div class="icon">ğŸ””</div><p>No consent requests yet.<br>When a doctor requests access to your records, it will appear here.</p></div>`;
    return;
  }

  let html = '';
  const pending = all.filter(r => r.status === 'PENDING');
  const rest = all.filter(r => r.status !== 'PENDING').slice().reverse();

  if (pending.length) {
    html += `<h3 style="font-size:13px;font-weight:700;color:var(--amber);margin-bottom:12px;text-transform:uppercase;letter-spacing:.05em;">â³ Pending (${pending.length})</h3>`;
    pending.forEach(req => {
      html += `
        <div class="consent-alert">
          <div class="title">ğŸ”” Access Request</div>
          <div class="body">
            <strong>${req.doctor_name}</strong><br>${req.facility_name}
          </div>
          <div class="scope-tags">
            ${req.scope.map(s => `<span class="scope-tag">${s.replace(/_/g,' ')}</span>`).join('')}
          </div>
          <div style="font-size:11px;color:var(--gray-600);margin-bottom:10px;">
            â„¹ï¸ This is a 4-hour, scoped access token. You can revoke it at any time.
          </div>
          <div class="consent-actions">
            <button class="btn btn-success" onclick="grantConsent('${req.id}')">âœ“ Grant</button>
            <button class="btn btn-danger" onclick="denyConsent('${req.id}')">âœ• Deny</button>
          </div>
        </div>
      `;
    });
  }

  const active = all.filter(r => r.status === 'ACTIVE' && new Date(r.expires_at) > new Date());
  if (active.length) {
    html += `<h3 style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:12px;text-transform:uppercase;letter-spacing:.05em;">ğŸ”“ Active Sessions</h3>`;
    active.forEach(req => {
      const secsLeft = Math.max(0, Math.floor((new Date(req.expires_at) - new Date()) / 1000));
      const h = Math.floor(secsLeft / 3600).toString().padStart(2,'0');
      const m = Math.floor((secsLeft % 3600) / 60).toString().padStart(2,'0');
      html += `
        <div class="session-card">
          <div class="title">ğŸ”“ Active â€” ${req.doctor_name}</div>
          <div style="font-size:12px;color:var(--gray-600);">${req.facility_name} Â· Expires in ${h}h ${m}m</div>
          <div style="font-size:12px;color:var(--gray-600);margin:6px 0;">Scope: ${req.scope.join(', ')}</div>
          <button class="btn btn-danger btn-sm" style="width:auto;margin-top:8px;" onclick="revokeConsent('${req.id}')">ğŸš« Revoke Access</button>
        </div>
      `;
    });
  }

  if (rest.length) {
    html += `<h3 style="font-size:13px;font-weight:700;color:var(--gray-600);margin-bottom:12px;text-transform:uppercase;letter-spacing:.05em;">History</h3>`;
    rest.forEach(req => {
      html += `
        <div class="card" style="margin-bottom:8px;">
          <div class="card-body" style="padding:12px 16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
              <div style="font-size:13px;font-weight:600;">${req.doctor_name}</div>
              <span class="badge badge-${req.status.toLowerCase()}">${req.status}</span>
            </div>
            <div style="font-size:12px;color:var(--gray-400);">${req.facility_name} Â· ${new Date(req.created_at).toLocaleDateString()}</div>
            <div style="font-size:11px;color:var(--gray-400);margin-top:2px;">${req.scope.join(', ')}</div>
          </div>
        </div>
      `;
    });
  }

  el.innerHTML = html;
}

function grantConsent(requestId) {
  const reqs = DB.get('consent_requests') || [];
  const req = reqs.find(r => r.id === requestId);
  if (!req) return;

  req.status = 'ACTIVE';
  req.expires_at = new Date(Date.now() + 4 * 60 * 60 * 1000).toISOString();
  req.token_id = uuid();
  DB.set('consent_requests', reqs);

  addPatientAuditLog('CONSENT_GRANTED', req.scope, req.facility_id);
  toast('âœ… Access granted. Session expires in 4 hours.', 'success');
  renderHome();
  renderConsents();
  updateConsentBadge();
}

function denyConsent(requestId) {
  const reqs = DB.get('consent_requests') || [];
  const req = reqs.find(r => r.id === requestId);
  if (!req) return;
  req.status = 'DENIED';
  DB.set('consent_requests', reqs);
  addPatientAuditLog('CONSENT_DENIED', req.scope, req.facility_id);
  toast('ğŸš« Access request denied.', 'success');
  renderHome();
  renderConsents();
  updateConsentBadge();
}

function revokeConsent(requestId) {
  if (!confirm('Revoke this access? The doctor will immediately lose access to your records.')) return;
  const reqs = DB.get('consent_requests') || [];
  const req = reqs.find(r => r.id === requestId);
  if (!req) return;
  req.status = 'REVOKED';
  DB.set('consent_requests', reqs);
  addPatientAuditLog('CONSENT_REVOKED', req.scope, req.facility_id);
  toast('ğŸ”’ Access revoked successfully.', 'success');
  renderHome();
  renderConsents();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR SCANNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQR() {
  const pendingQRs = (DB.get('qr_pending') || []).filter(q => q.full_patient_mnid === currentPatient.mnid);
  const listEl = document.getElementById('pending-qr-list');

  if (!pendingQRs.length) {
    listEl.innerHTML = `<div style="padding:20px;text-align:center;color:var(--gray-400);font-size:13px;">No pending QR records</div>`;
    return;
  }

  listEl.innerHTML = pendingQRs.map(q => `
    <div class="record-item" onclick="importFromPending('${q.record_id}')">
      <div class="record-icon encounter">ğŸ“‹</div>
      <div class="record-meta">
        <div class="title">New record from ${q.issuer_facility_id}</div>
        <div class="sub">Issued: ${new Date(q.issued_at).toLocaleString()}</div>
      </div>
      <span style="background:var(--lightblue);color:var(--navy);font-size:11px;font-weight:700;padding:4px 8px;border-radius:6px;">Tap to import</span>
    </div>
  `).join('');
}

function processManualQR() {
  const input = document.getElementById('qr-manual-input').value.trim();
  if (!input) return toast('Enter a record code', 'warning');

  // Try to parse as JSON QR payload
  try {
    const payload = JSON.parse(input);
    if (payload.record_id) {
      importFromPending(payload.record_id);
      return;
    }
  } catch (e) {}

  // Try to find by record ID directly
  const records = DB.get('records') || [];
  const r = records.find(x => x.id === input);
  if (r && r.patient_mnid === currentPatient.mnid) {
    r.synced_to_device = true;
    DB.set('records', records);
    // Remove from pending
    const qrs = (DB.get('qr_pending') || []).filter(q => q.full_record_id !== r.id);
    DB.set('qr_pending', qrs);
    showQRSuccess(r);
    return;
  }
  toast('âš ï¸ Record not found or does not belong to your MNID.', 'error');
}

function importFromPending(recordId) {
  const records = DB.get('records') || [];
  const r = records.find(x => x.id === recordId);
  if (!r || r.patient_mnid !== currentPatient.mnid) {
    toast('âš ï¸ Record not found.', 'error'); return;
  }
  r.synced_to_device = true;
  DB.set('records', records);

  const qrs = (DB.get('qr_pending') || []).filter(q => q.full_record_id !== recordId);
  DB.set('qr_pending', qrs);

  addPatientAuditLog('QR_RECORD_IMPORTED', [r.record_type], r.facility_id);
  showQRSuccess(r);
  renderQR();
}

function showQRSuccess(r) {
  const el = document.getElementById('qr-result');
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="alert alert-success">
      âœ… <strong>Record imported successfully!</strong><br>
      ${r.diagnosis} from ${r.facility_name}<br>
      <span class="enc-badge" style="margin-top:8px;">ğŸ”’ Stored with AES-256 encryption</span>
    </div>
  `;
  toast('ğŸ“± Record saved to your health passport!', 'success');
  setTimeout(() => el.classList.add('hidden'), 6000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProfile() {
  const p = currentPatient;
  const records = (DB.get('records') || []).filter(r => r.patient_mnid === p.mnid);
  const allergies = [...new Set(records.filter(r => r.allergies).flatMap(r => r.allergies.split(',')).map(a => a.trim()).filter(a => a && a.toLowerCase() !== 'none known'))];

  document.getElementById('profile-content').innerHTML = `
    <div class="profile-hero">
      <div class="profile-avatar">${p.name.split(' ').map(w=>w[0]).join('').slice(0,2)}</div>
      <div class="profile-name">${p.name}</div>
      <div class="profile-mnid">${p.mnid}</div>
      <div style="margin-top:8px;font-size:12px;opacity:.7;">Tier 1 â€” MNID Verified âœ“</div>
    </div>

    <div class="content-padded">
      ${allergies.length > 0 ? `
        <div class="alert alert-danger">
          âš ï¸ <strong>Allergy Alert:</strong> ${allergies.join(', ')}
        </div>
      ` : ''}

      <div class="card">
        <div class="card-header"><h3>Personal Details</h3></div>
        <div class="card-body" style="padding:0 16px;">
          <div class="info-row"><span class="label">Full Name</span><span class="value">${p.name}</span></div>
          <div class="info-row"><span class="label">MNID</span><span class="value" style="font-family:monospace;font-size:12px;">${p.mnid}</span></div>
          <div class="info-row"><span class="label">Date of Birth</span><span class="value">${p.dob}</span></div>
          <div class="info-row"><span class="label">Phone</span><span class="value">${p.phone || 'â€”'}</span></div>
          <div class="info-row"><span class="label">Registered</span><span class="value">${p.registered_at}</span></div>
          <div class="info-row"><span class="label">ID Tier</span><span class="value"><span class="badge badge-info">Tier ${p.tier} â€” MNID</span></span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>Health Summary</h3></div>
        <div class="card-body" style="padding:0 16px;">
          <div class="info-row"><span class="label">Total Records</span><span class="value">${records.length}</span></div>
          <div class="info-row"><span class="label">Facilities</span><span class="value">${p.facilities?.length || records.map(r=>r.facility_id).filter((v,i,a)=>a.indexOf(v)===i).length}</span></div>
          <div class="info-row"><span class="label">Known Allergies</span><span class="value" style="color:${allergies.length ? 'var(--red)' : 'var(--green)'};">${allergies.length ? allergies.join(', ') : 'None recorded'}</span></div>
          <div class="info-row"><span class="label">Encryption</span><span class="value"><span class="enc-badge" style="font-size:10px;">ğŸ”’ AES-256-GCM</span></span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>Security & Privacy</h3></div>
        <div class="card-body" style="padding:0 16px;">
          <div class="info-row" style="cursor:pointer;" onclick="navigate('access-history')">
            <span class="label">Access History</span>
            <span style="color:var(--blue);font-size:13px;">View â†’</span>
          </div>
          <div class="info-row" style="cursor:pointer;" onclick="navigate('consents')">
            <span class="label">Manage Consents</span>
            <span style="color:var(--blue);font-size:13px;">View â†’</span>
          </div>
          <div class="info-row" style="cursor:pointer;" onclick="navigate('ussd')">
            <span class="label">USSD Mode (*860#)</span>
            <span style="color:var(--blue);font-size:13px;">Open â†’</span>
          </div>
        </div>
      </div>

      <button class="btn btn-danger" style="margin-top:4px;" onclick="doLogout()">Sign Out</button>
      <div style="height:20px;"></div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCESS HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAccessHistory() {
  const logs = (DB.get('audit_log') || []).slice().reverse();
  const el = document.getElementById('access-history-content');

  if (!logs.length) {
    el.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“œ</div><p>No access events recorded yet.</p></div>`;
    return;
  }

  const eventMeta = {
    RECORD_CREATED: { icon: 'ğŸ“‹', bg: 'var(--lightblue)', label: 'Record Created' },
    CONSENT_GRANTED: { icon: 'âœ…', bg: 'var(--green-light)', label: 'Access Granted' },
    CONSENT_DENIED: { icon: 'ğŸš«', bg: 'var(--red-light)', label: 'Access Denied' },
    CONSENT_REVOKED: { icon: 'ğŸ”’', bg: 'var(--red-light)', label: 'Access Revoked' },
    CONSENT_REQUESTED: { icon: 'ğŸ“¤', bg: 'var(--amber-light)', label: 'Access Requested' },
    CROSS_FACILITY_ACCESS: { icon: 'ğŸ”', bg: '#EDE9FE', label: 'Cross-Facility Access' },
    SESSION_EXPIRED: { icon: 'â±', bg: 'var(--gray-100)', label: 'Session Expired' },
    QR_RECORD_IMPORTED: { icon: 'ğŸ“·', bg: 'var(--lightblue)', label: 'QR Record Imported' },
  };

  const html = `
    <div class="alert alert-info">ğŸ”’ This log is append-only. MNID stored as SHA-256 hash only â€” your identity is never exposed.</div>
    ${logs.map(l => {
      const m = eventMeta[l.event_type] || { icon: 'ğŸ“', bg: 'var(--gray-100)', label: l.event_type.replace(/_/g,' ') };
      return `
        <div class="access-row">
          <div class="access-icon" style="background:${m.bg};">${m.icon}</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:600;">${m.label}</div>
            <div style="font-size:11px;color:var(--gray-400);margin-top:2px;">${l.requesting_facility} Â· ${(l.scope||[]).join(', ')}</div>
          </div>
          <div style="text-align:right;">
            <span class="badge badge-${l.outcome==='SUCCESS'?'active':l.outcome==='PENDING'?'pending':'revoked'}" style="font-size:10px;">${l.outcome}</span>
            <div style="font-size:10px;color:var(--gray-400);margin-top:2px;">${new Date(l.timestamp).toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
          </div>
        </div>
      `;
    }).join('')}
  `;
  el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USSD SIMULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USSD_MENUS = {
  main: () => [
    'CHIPATALA CONNECT',
    `Welcome, ${currentPatient?.name.split(' ')[0] || 'User'}`,
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    '1. View Health ID',
    '2. Grant Access (PIN)',
    '3. Revoke Access',
    '4. Book Appointment',
    '5. Vaccination Status',
    '6. Register Patient (HSA)',
    '0. Exit',
  ],
  view_id: () => [
    'YOUR HEALTH ID',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    `MNID: ${currentPatient?.mnid}`,
    `Name: ${currentPatient?.name}`,
    `DOB:  ${currentPatient?.dob}`,
    `Tier: Tier 1 - MNID`,
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    '0. Back',
  ],
  grant: () => {
    const pending = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.status === 'PENDING');
    if (!pending.length) return ['NO PENDING REQUESTS', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'No access requests.', 'Ask your doctor to', 'send a request first.', '0. Back'];
    const req = pending[0];
    return ['ACCESS REQUEST', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', `Dr: ${req.doctor_name}`, `Facility: ${req.facility_id}`, `Scope: ${req.scope.slice(0,2).join(',')}`, 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', '1. Approve (4 hrs)', '2. Deny', '0. Back'];
  },
  revoke: () => {
    const active = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.status === 'ACTIVE' && new Date(r.expires_at) > new Date());
    if (!active.length) return ['NO ACTIVE SESSIONS', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'No active access.', '0. Back'];
    return ['REVOKE ACCESS', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', `Active: ${active.length} session(s)`, `Dr: ${active[0].doctor_name}`, 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', '1. Revoke all', '0. Back'];
  },
  vaccinations: () => {
    const vax = (DB.get('records') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.record_type === 'vaccination');
    if (!vax.length) return ['VACCINATIONS', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'No vaccination', 'records found.', '0. Back'];
    return ['VACCINATIONS', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', ...vax.map(v => `+ ${v.diagnosis.slice(0,20)}`), 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', '0. Back'];
  },
};

let ussdCurrentMenu = 'main';
let ussdGrantReqId = null;
let ussdRevokeReqId = null;

function initUSSD() {
  ussdCurrentMenu = 'main';
  renderUSSD(USSD_MENUS.main());
}

function renderUSSD(lines) {
  document.getElementById('ussd-display').innerHTML = lines.map(l => `<div class="ussd-line">${l}</div>`).join('');
}

function ussdSend() {
  const val = document.getElementById('ussd-input').value.trim();
  document.getElementById('ussd-input').value = '';
  handleUSSD(val);
}

function handleUSSD(input) {
  if (ussdCurrentMenu === 'main') {
    if (input === '1') { ussdCurrentMenu = 'view_id'; renderUSSD(USSD_MENUS.view_id()); }
    else if (input === '2') { ussdCurrentMenu = 'grant'; renderUSSD(USSD_MENUS.grant()); }
    else if (input === '3') { ussdCurrentMenu = 'revoke'; renderUSSD(USSD_MENUS.revoke()); }
    else if (input === '4') { renderUSSD(['APPOINTMENTS', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'SMS booking not yet', 'available via USSD.', 'Visit the clinic or', 'use the mobile app.', '0. Back']); }
    else if (input === '5') { ussdCurrentMenu = 'vaccinations'; renderUSSD(USSD_MENUS.vaccinations()); }
    else if (input === '0') { renderUSSD(['GOODBYE', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'Session ended.', 'Dial *860# to start.']); }
    else renderUSSD([...USSD_MENUS.main(), '', '> Invalid option']);
  } else if (ussdCurrentMenu === 'grant') {
    const pending = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.status === 'PENDING');
    if (input === '1' && pending.length) {
      grantConsent(pending[0].id);
      renderUSSD(['ACCESS GRANTED', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', `Dr: ${pending[0].doctor_name}`, 'Session: 4 hours', 'Scope approved.', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'Press 0 to go back.']);
    } else if (input === '2' && pending.length) {
      denyConsent(pending[0].id);
      renderUSSD(['ACCESS DENIED', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'Request rejected.', '0. Back']);
    } else if (input === '0') { ussdCurrentMenu = 'main'; renderUSSD(USSD_MENUS.main()); }
    else renderUSSD([...USSD_MENUS.grant(), '', '> Invalid option']);
  } else if (ussdCurrentMenu === 'revoke') {
    const active = (DB.get('consent_requests') || []).filter(r => r.patient_mnid === currentPatient?.mnid && r.status === 'ACTIVE');
    if (input === '1' && active.length) {
      active.forEach(r => revokeConsent(r.id));
      renderUSSD(['ALL ACCESS REVOKED', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'All sessions ended.', 'Data cleared.', '0. Back']);
    } else if (input === '0') { ussdCurrentMenu = 'main'; renderUSSD(USSD_MENUS.main()); }
    else renderUSSD([...USSD_MENUS.revoke(), '', '> Invalid option']);
  } else {
    if (input === '0') { ussdCurrentMenu = 'main'; renderUSSD(USSD_MENUS.main()); }
    else renderUSSD(['Press 0 to go back.']);
  }
}

function ussdReset() { initUSSD(); }
document.addEventListener('keydown', e => {
  if (currentView === 'ussd' && e.key === 'Enter') ussdSend();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIT & UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPatientAuditLog(eventType, scope, facility) {
  DB.push('audit_log', {
    event_id: uuid(),
    event_type: eventType,
    timestamp: new Date().toISOString(),
    patient_mnid_hash: 'sha256:' + currentPatient.mnid.replace(/\D/g, ''),
    requesting_facility: facility || 'PATIENT_APP',
    requesting_clinician: 'PATIENT',
    scope: scope || [],
    outcome: 'SUCCESS'
  });
}

function doLogout() {
  if (sessionPollInterval) clearInterval(sessionPollInterval);
  currentPatient = null;
  pinBuffer = '';
  document.getElementById('screen-app').classList.add('hidden');
  document.getElementById('screen-auth').classList.remove('hidden');
  document.getElementById('auth-login').classList.remove('hidden');
  document.getElementById('auth-register').classList.add('hidden');
  updatePinDots();
}

function toast(msg, type = 'default') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

document.getElementById('ussd-input')?.addEventListener('keydown', e => { if (e.key === 'Enter') ussdSend(); });
</script>
</body>
</html>
